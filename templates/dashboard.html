<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Médico - CardioHome</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-blue: #007BFF; /* Un azul ligeramente más brillante y moderno */
            --primary-dark-blue: #0056b3;
            --secondary-accent: #28a745; /* Verde para éxito/acciones positivas */
            --warning-accent: #ffc107; /* Amarillo para advertencias/adiciones */
            --info-accent: #17a2b8; /* Cian para información/nuevo tipo de carga */
            --background-light: #f8f9fa; /* Fondo más claro */
            --card-background: #ffffff;
            --text-dark: #343a40; /* Texto más oscuro para contraste */
            --text-medium: #6c757d;
            --border-light: #e9ecef; /* Borde más claro */
            --shadow-subtle: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --sidebar-width: 280px;
        }

        body {
            margin: 0;
            font-family: 'Open Sans', sans-serif; /* Una fuente limpia y legible para el cuerpo */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Estilos de la barra lateral */
        .sidebar {
            background: var(--primary-blue); /* Azul primario sólido */
            color: white;
            padding: 30px 20px;
            box-shadow: 4px 0 20px var(--shadow-medium);
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            position: sticky; /* Barra lateral fija para contenido largo */
            top: 0;
            height: 100vh;
            overflow-y: auto; /* Habilitar desplazamiento si el contenido es demasiado largo */
            scrollbar-width: none; /* Ocultar barra de desplazamiento para Firefox */
        }

        .sidebar::-webkit-scrollbar {
            display: none; /* Ocultar barra de desplazamiento para Chrome, Safari, Opera */
        }

        .sidebar .logo-container {
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
            width: 100%;
            text-align: center;
        }

        .sidebar img {
            max-width: 180px; /* Logo ligeramente más grande */
            height: auto;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.3)); /* Sombra sutil en el logo */
        }

        .sidebar h3 {
            margin-top: 15px;
            margin-bottom: 5px;
            font-family: 'Montserrat', sans-serif; /* Una fuente más distintiva para los títulos */
            font-weight: 700;
            font-size: 1.8em;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.95);
        }

        .sidebar p {
            font-weight: 300;
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 25px;
        }

        .sidebar hr {
            border: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin: 20px 0;
            width: 80%;
        }

        .sidebar nav {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            width: calc(100% - 40px); /* Ajuste para el padding */
            justify-content: flex-start;
            font-weight: 500;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.05em;
        }

        .sidebar a:hover {
            background-color: var(--primary-dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .sidebar a .icon {
            font-size: 1.3em;
            width: 25px; /* Ancho fijo para los iconos */
            text-align: center;
        }

        /* Estilos del contenido principal */
        .main-content {
            flex-grow: 1;
            padding: 40px;
            background-color: var(--background-light);
            overflow-x: hidden; /* Prevenir desplazamiento horizontal */
        }

        .main-content h2 {
            color: var(--primary-blue);
            margin-bottom: 35px;
            font-size: 2.5em;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            position: relative;
            padding-bottom: 15px;
        }

        .main-content h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 80px; /* Subrayado más corto y moderno */
            height: 4px;
            background-color: var(--primary-blue);
            border-radius: 2px;
        }

        /* Estilos base de las tarjetas */
        .card {
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px var(--shadow-subtle);
            margin-bottom: 35px;
            border: 1px solid var(--border-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow-medium);
        }

        .card h3 {
            margin-bottom: 20px;
            color: var(--primary-blue);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Variaciones específicas de tarjetas */
        .card.add-establishment {
            border-left: 8px solid var(--warning-accent);
        }

        .card.add-establishment h3 {
            color: var(--warning-accent);
        }

        .card.upload-roster { /* Nuevo estilo de tarjeta para carga de nómina */
            border-left: 8px solid var(--info-accent);
        }
        .card.upload-roster h3 {
            color: var(--info-accent);
        }

        .card.calendar {
            border-left: 8px solid var(--primary-blue);
        }

        .card.doctor-ids-table {
            border-left: 8px solid var(--secondary-accent);
        }
        .card.doctor-ids-table h4 {
            color: var(--secondary-accent);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card.assigned-nominations { /* Nuevo estilo para nóminas asignadas */
            border-left: 8px solid var(--secondary-accent);
        }
        .card.assigned-nominations h3 {
            color: var(--secondary-accent);
        }
        .card.assigned-nominations ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .card.assigned-nominations li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .card.assigned-nominations li:last-child {
            border-bottom: none;
        }
        .card.assigned-nominations li a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: color 0.2s ease;
        }
        .card.assigned-nominations li a:hover {
            color: var(--primary-dark-blue);
            text-decoration: underline;
        }
        .card.assigned-nominations .no-nominations {
            color: var(--text-medium);
            font-style: italic;
            padding-top: 10px;
        }


        /* Estilos de tabla */
        table {
            width: 100%;
            border-collapse: separate; /* Usar separate para esquinas redondeadas en celdas */
            border-spacing: 0; /* Eliminar espaciado predeterminado */
            margin-top: 20px;
            border-radius: 8px; /* Esquinas redondeadas para toda la tabla */
            overflow: hidden; /* Ocultar contenido fuera del border-radius */
        }

        th,
        td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
            border-right: 1px solid var(--border-light); /* Añadir borde derecho para efecto de cuadrícula */
        }

        th:last-child, td:last-child {
            border-right: none; /* Eliminar borde derecho en la última columna */
        }

        th {
            background-color: #e9f0f8; /* Fondo de encabezado más claro */
            font-weight: 600;
            color: var(--primary-dark-blue);
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        th:first-child { border-top-left-radius: 8px; }
        th:last-child { border-top-right-radius: 8px; }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: #f0f7ff;
            transition: background 0.2s ease-in-out;
        }

        /* Estilos de formulario */
        form {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr; /* Por defecto, una sola columna */
            gap: 15px;
        }

        form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95em;
        }

        input[type="file"],
        input[type="number"],
        input[type="text"],
        input[type="date"],
        select {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            width: 100%;
            box-sizing: border-box;
            font-size: 1em;
            color: var(--text-dark);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="file"]:focus,
        input[type="number"]:focus,
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        input[type="file"]::file-selector-button {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            margin-right: 15px;
            font-weight: 500;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: var(--primary-dark-blue);
            transform: translateY(-1px);
        }

        button {
            padding: 12px 25px;
            border: none;
            background-color: var(--primary-blue);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.05em;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 15px;
            width: auto; /* Mantener el ancho natural del botón */
            display: inline-flex; /* Para alineación de iconos */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background-color: var(--primary-dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Estilo de botón específico */
        .add-establishment button {
            background-color: var(--warning-accent);
            color: var(--text-dark); /* Texto más oscuro para botón amarillo */
        }
        .add-establishment button:hover {
            background-color: #e0a800; /* Amarillo más oscuro al pasar el ratón */
            color: white;
        }

        .upload-roster button { /* Estilo para el botón de carga de nómina */
            background-color: var(--info-accent);
        }
        .upload-roster button:hover {
            background-color: #117a8b; /* Cian más oscuro al pasar el ratón */
        }


        .establishment-details a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s ease;
            margin-top: 5px;
        }

        .establishment-details a:hover {
            color: var(--primary-dark-blue);
            text-decoration: underline;
        }

        .establishment-details p.no-form {
            color: var(--text-medium);
            font-style: italic;
            margin-top: 10px;
        }

        /* Ajustes responsivos */
        @media (min-width: 768px) {
            body {
                flex-direction: row;
            }

            .sidebar {
                width: var(--sidebar-width);
            }

            .main-content {
                width: calc(100% - var(--sidebar-width));
                padding: 40px 50px; /* Más padding horizontal */
            }

            form {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Dos columnas para formularios en pantallas más anchas */
            }

            form button {
                grid-column: 1 / -1; /* Hacer que el botón abarque todas las columnas */
                justify-self: start; /* Alinear el botón al inicio */
            }
        }

        @media (max-width: 767px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 20px 15px;
                flex-direction: row;
                justify-content: center; /* Centrar elementos en móvil */
                flex-wrap: wrap; /* Permitir ajuste de línea */
                text-align: center;
            }

            .sidebar .logo-container {
                width: auto;
                border-bottom: none;
                margin-bottom: 15px;
            }

            .sidebar img {
                max-width: 120px;
                margin-bottom: 10px;
            }

            .sidebar h3,
            .sidebar p {
                width: 100%; /* Tomar todo el ancho */
                margin-bottom: 10px;
            }

            .sidebar nav {
                flex-direction: row; /* Navegación horizontal en móvil */
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px; /* Espacio entre elementos de navegación móvil */
            }

            .sidebar a {
                padding: 10px 15px;
                font-size: 0.9em;
                width: auto; /* Ajustar ancho para elementos en línea */
                flex-grow: 1; /* Permitir que los enlaces crezcan */
                justify-content: center;
            }

            .sidebar hr {
                display: none; /* Ocultar hr en móvil */
            }

            .main-content {
                padding: 25px 20px;
            }

            .main-content h2 {
                font-size: 1.8em;
                margin-bottom: 25px;
                text-align: center;
                width: 100%;
            }
            .main-content h2::after {
                left: 50%;
                transform: translateX(-50%); /* Centrar subrayado en móvil */
            }

            .card {
                padding: 20px;
                margin-bottom: 25px;
            }

            .card h3 {
                font-size: 1.5em;
                text-align: center;
                display: block; /* Apilar icono y texto */
            }

            form button {
                width: 100%;
                margin-top: 20px;
            }

            th, td {
                padding: 12px 15px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo-container">
            <img src="/static/cardiohome.png" alt="Logo CardioHome" />
            <h3>CardioHome</h3>
        </div>
        <p>Bienvenida, {{ usuario }}</p>

        <nav>
            {% if usuario == 'admin' %}
            <a href="/colegios"><span class="icon"><i class="fas fa-clipboard-list"></i></span><span>Colegios Evaluados</span></a>
            {% else %} {# Esta es la vista para el rol de doctor #}
            <a href="/mis_nominas"><span class="icon"><i class="fas fa-file-alt"></i></span><span>Mis Nóminas Asignadas</span></a>
            {% endif %}

            <a href="/logout"><span class="icon"><i class="fas fa-sign-out-alt"></i></span><span>Cerrar sesión</span></a>
        </nav>
    </div>

    <div class="main-content">
        <h2>Panel de Actividades</h2> {# Título general cambiado #}

        {% if usuario == 'admin' %}
        <div class="card doctor-ids-table">
            <h4><i class="fas fa-id-card-alt"></i> IDs disponibles de Doctoras</h4>
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Usuario</th>
                        <th>ID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in doctoras %}
                    <tr>
                        <td>{{ doc.nombre }}</td>
                        <td>{{ doc.usuario }}</td>
                        <td>{{ doc.id }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card add-establishment">
            <h3><i class="fas fa-plus-circle"></i> Agregar nuevo establecimiento (Visita programada)</h3>
            <form action="/admin/agregar" method="POST" enctype="multipart/form-data">
                <div>
                    <label for="nombre">Nombre del establecimiento:</label>
                    <input type="text" id="nombre" name="nombre" required />
                </div>
                <div>
                    <label for="fecha">Fecha de visita:</label>
                    <input type="date" id="fecha" name="fecha" required />
                </div>
                <div>
                    <label for="horario">Horario:</label>
                    <input type="text" id="horario" name="horario" placeholder="Ej: 09:00 - 10:30" required />
                </div>
                <div>
                    <label for="obs">Observaciones:</label>
                    <input type="text" id="obs" name="obs" />
                </div>
                <div>
                    <label for="doctora">Asignar a doctora (ID Supabase):</label>
                    <select id="doctora" name="doctora" required>
                        <option value="">Seleccionar doctora</option>
                        {% for doc in doctoras %}
                       <option value="{{ doc.id|e }}">{{ doc.nombre }} ({{ doc.usuario }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="formulario">Formulario (PDF, Word o Excel):</label>
                    <input type="file" id="formulario" name="formulario" accept=".pdf,.doc,.docx,.xls,.xlsx" required />
                </div>
                <div>
                    <label for="alumnos_agregar">Cantidad de alumnos:</label>
                    <input type="number" id="alumnos_agregar" name="alumnos" min="0" required />
                </div>
                <button type="submit"><i class="fas fa-paper-plane"></i> Agregar Establecimiento</button>
            </form>
        </div>

        <div class="card upload-roster"> {# Nueva tarjeta para carga de nómina Excel #}
            <h3><i class="fas fa-file-upload"></i> Cargar Nómina Médica (Para formularios)</h3>
            <form action="/admin/cargar_nomina" method="POST" enctype="multipart/form-data">
                <div>
                    <label for="tipo_nomina">Tipo de Nómina:</label>
                    <select id="tipo_nomina" name="tipo_nomina" required>
                        <option value="">Seleccionar tipo</option>
                        <option value="medicina_familiar">Medicina Familiar</option>
                        <option value="neurologia">Neurología</option>
                    </select>
                </div>
                 <div>
                    <label for="nombre_especifico">Nombre de la Nómina/Referencia (Establecimiento):</label>
                    <input type="text" id="nombre_especifico" name="nombre_especifico" placeholder="Ej: Clínica Los Andes - Neuro" required>
                </div>
                <div>
                    <label for="doctora_nomina">Asignar a doctora (ID Supabase):</label>
                    <select id="doctora_nomina" name="doctora" required>
                        <option value="">Seleccionar doctora</option>
                        {% for doc in doctoras %}
                       <option value="{{ doc.id|e }}">{{ doc.nombre }} ({{ doc.usuario }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="excel_nomina">Sube el archivo Excel de la nómina:</label>
                    <input type="file" id="excel_nomina" name="excel" accept=".xlsx,.xls,.csv" required>
                </div>
                <button type="submit"><i class="fas fa-upload"></i> Cargar Nómina</button>
            </form>
        </div>

        {% else %} {# Esta sección es para la vista del doctor #}
        <div class="card assigned-nominations">
            <h3><i class="fas fa-tasks"></i> Mis Nóminas/Establecimientos Asignados</h3>
            <ul>
                {% if assigned_nominations %}
                    {% for nomina in assigned_nominations %}
                    <li>
                        <a href="/relleno_formularios/{{ nomina.id }}">
                            <i class="fas fa-file-signature"></i> {{ nomina.nombre_establecimiento }} ({{ nomina.tipo_nomina_display }})
                        </a>
                    </li>
                    {% endfor %}
                {% else %}
                    <p class="no-nominations">No tienes nóminas o establecimientos asignados por ahora.</p>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        <div class="card calendar">
            <h3><i class="fas fa-calendar-alt"></i> Calendario de Visitas</h3>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Horario</th>
                        <th>Establecimiento</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for evento in eventos %}
                    <tr>
                        <td>{{ evento.fecha }}</td>
                        <td>{{ evento.horario }}</td>
                        <td>{{ evento.nombre }}</td>
                        <td>{{ evento.observaciones }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if usuario != 'admin' %}
        {# Tarjetas originales "establishment-details" para doctores, si aún se necesitan para otros propósitos #}
        {# Podrían ser redundantes si 'assigned-nominations' se convierte en la forma principal en que los doctores acceden a los formularios #}
        {# Se mantiene aquí comentado por ahora en caso de que tengas otros tipos de asignaciones de doctor #}
        {% comment %}
        {% for evento in eventos %}
        <div class="card establishment-details">
            <h3><i class="fas fa-hospital"></i> {{ evento.nombre }}</h3>

            {% if evento.url_archivo %}
            <p>
                <strong>Formulario base (subido por el administrador):</strong><br>
                <a href="{{ evento.url_archivo }}" target="_blank" download><i class="fas fa-download"></i> Descargar Formulario: {{ evento.nombre_archivo }}</a>
            </p>
            {% else %}
            <p class="no-form"><i class="fas fa-info-circle"></i> <em>No hay formulario base disponible para este establecimiento.</em></p>
            {% endif %}

            {% set tiene_formulario = false %}
            {% for f in formularios %}
                {% if f.establecimientos_id == evento.id %}
                    {% set tiene_formulario = true %}
                    <p>
                        <a href="{{ f.url_archivo }}" target="_blank" download><i class="fas fa-file-download"></i> Descargar Formulario Completado: {{ f.nombre_archivo }}</a>
                    </p>
                {% endif %}
            {% endfor %}

            {% if not tiene_formulario %}
                <p class="no-form"><i class="fas fa-exclamation-circle"></i> <em>No hay formularios completados subidos aún.</em></p>
            {% endif %}

            <form action="/subir/{{ evento.id }}" method="POST" enctype="multipart/form-data">
                <div>
                    <label for="archivo_subir_{{ evento.id }}">Subir formularios completados (puedes seleccionar varios):</label><br>
                    <input type="file" id="archivo_subir_{{ evento.id }}" name="archivo" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.xlsm" required><br>
                </div>
                <button type="submit"><i class="fas fa-upload"></i> Subir Formularios</button>
            </form>

            <form action="/evaluados/{{ evento.id }}" method="POST">
                <div>
                    <label for="alumnos_evaluados_{{ evento.id }}">Cantidad de alumnos evaluados:</label><br>
                    <input type="number" id="alumnos_evaluados_{{ evento.id }}" name="alumnos" min="0" required><br>
                </div>
                <button type="submit"><i class="fas fa-save"></i> Registrar Cantidad</button>
            </form>
        </div>
        {% endfor %}
        {% endcomment %}
        {% endif %}

        <div class="card calendar">
            <h3><i class="fas fa-inbox"></i> Formularios Subidos por Establecimiento</h3>
            <table>
                <thead>
                    <tr>
                        <th>Establecimiento</th>
                        <th>Formularios Subidos</th>
                        <th>Ver Archivos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for est in establecimientos %}
                    <tr>
                        <td>{{ est.nombre }}</td>
                        <td>{{ conteo.get(est.id, 0) }}</td>
                        <td>
                            {% for f in formularios if f.establecimientos_id == est.id %}
                            <a href="{{ f.url_archivo }}" target="_blank"><i class="fas fa-file"></i> {{ f.nombre_archivo }}</a><br />
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
