<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rellenar Formulario de Medicina Familiar - CardioHome</title>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables CSS para una gestión de colores y espaciado más fácil */
        :root {
            --primary-dark: hsl(210, 29%, 18%); /* Azul pizarra muy oscuro */
            --primary-medium: hsl(210, 15%, 28%); /* Azul pizarra medio */
            --primary-light: hsl(210, 16%, 92%); /* Gris azulado muy claro */
            --background-body: linear-gradient(135deg, hsl(200, 20%, 98%) 0%, hsl(210, 15%, 96%) 100%); /* Degradado suave para el cuerpo */
            --accent-green: hsl(140, 65%, 45%); /* Verde vibrante */
            --accent-red: hsl(0, 75%, 58%); /* Rojo intenso */
            --accent-blue: hsl(200, 70%, 55%); /* Azul cielo brillante */
            --google-drive-blue: #4285F4; /* Azul de Google Drive */
            --signature-purple: #8B5CF6; /* Púrpura para firma */
            --text-dark: hsl(210, 10%, 15%);
            --text-light: hsl(0, 0%, 99%);
            --border-color: hsl(210, 10%, 82%); /* Borde más definido */
            --shadow-subtle: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --shadow-strong: rgba(0, 0, 0, 0.25);
            --border-radius-base: 14px;
            --padding-base: 28px;
            --gap-base: 30px;
        }

        /* Estilos generales del cuerpo */
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--background-body); /* Fondo degradado */
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 20px; /* Reducido para mejor visualización en pantallas pequeñas */
            margin: 0; /* Asegura que no haya márgenes no deseados */
        }

        /* Contenedor principal para centrar el contenido */
        .main-content-wrapper {
            max-width: 1200px; /* Ancho máximo para el contenido principal */
            margin: 20px auto; /* Centrar y añadir margen superior/inferior */
            padding: 0 20px; /* Espaciado interno */
            flex-grow: 1; /* Permite que el wrapper crezca y ocupe espacio disponible */
        }

        header {
            background-color: #f0f4f8; /* Fondo del header para consistencia */
            padding: 20px 0;
            text-align: center;
            position: relative; /* Para posicionar los botones */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); /* Sombra suave */
        }

        header img {
            max-width: 150px; /* Tamaño más consistente */
            margin-bottom: 10px;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Efecto al pasar el mouse */
        }

        header img:hover {
            transform: scale(1.05); /* Ligeramente más grande */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Sombra al pasar el mouse */
        }

        header h1 {
            font-size: 1.8rem; /* Tamaño de fuente más grande */
            color: #333; /* Color de texto más oscuro */
            margin-top: 5px;
            font-weight: 700;
        }

        /* Estilos para los botones del header */
        .header-btn {
            position: absolute;
            top: 20px;
            padding: 10px 18px;
            border-radius: 25px; /* Más redondeado */
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .back-to-dashboard-btn {
            left: 20px;
            background-color: #6c757d; /* Gris */
            color: #fff;
        }
        .back-to-dashboard-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        .logout-btn {
            right: 20px;
            background-color: #dc3545; /* Rojo */
            color: #fff;
        }
        .logout-btn:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        /* Nuevos botones para imprimir y exportar Excel */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Para que los botones se ajusten en pantallas pequeñas */
        }

        .action-buttons button {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .action-buttons button:hover {
            background-color: hsl(200, 70%, 45%);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        /* Contador de evaluaciones */
        .evaluation-counter {
            background-color: #e6f7ff; /* Azul claro */
            border: 1px solid #99d6ff;
            border-radius: 10px;
            padding: 15px 25px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a73e8; /* Azul del tema */
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            flex-wrap: wrap; /* Para responsividad */
        }
        .evaluation-counter i {
            color: #1a73e8;
            font-size: 1.3em;
        }
        .evaluation-counter strong {
            color: #34a853; /* Verde de éxito */
            font-size: 1.1em;
        }
        .evaluation-counter button {
            background-color: #1a73e8;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 15px;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .evaluation-counter button:hover {
            background-color: #155ab6;
            transform: translateY(-2px);
        }

        #buscador {
            width: 100%;
            max-width: 500px; /* Un poco más ancho para búsquedas */
            display: block;
            margin: 0 auto 20px; /* Reducido margen inferior */
            padding: 12px 15px;
            border: 1px solid #b0c2d4; /* Borde más suave */
            border-radius: 8px;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        #buscador:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.3);
            outline: none;
        }

        /* Estilos para el nuevo filtro de estado */
        .filter-group {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 30px; /* Más espacio */
            background-color: #f9f9f9;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        .filter-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: color 0.2s ease;
        }
        .filter-group label:hover {
            color: #1a73e8;
        }
        .filter-group input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #bbb;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            position: relative;
            flex-shrink: 0; /* Evita que el radio button se comprima */
        }
        .filter-group input[type="radio"]:checked {
            border-color: #1a73e8;
            background-color: #1a73e8;
        }
        .filter-group input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 10px;
            height: 10px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }


        details {
            margin-bottom: 25px; /* Más espacio entre estudiantes */
            border-radius: 12px;
            overflow: hidden; /* Asegura bordes redondeados */
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* Sombra para el detalle */
            transition: all 0.3s ease;
        }
        details[open] {
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* Sombra más fuerte al abrir */
        }

        summary {
            background: #1a73e8; /* azul uniforme para todos */
            color: #fff;
            padding: 18px 25px; /* Más padding */
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex; /* Para alinear icono y texto */
            align-items: center;
            justify-content: space-between;
            font-size: 1.15rem; /* Texto de sumario más grande */
            transition: background 0.3s ease;
        }
        summary:hover {
            background: #155ab6;
        }
        summary::marker { /* Ocultar el marcador predeterminado */
            display: none;
            content: "";
        }
        summary::-webkit-details-marker { /* Para Webkit */
            display: none;
        }
        summary:focus {
            outline: none; /* Eliminar el contorno de enfoque */
        }
        details[open] summary {
            border-bottom: 1px solid rgba(255,255,255,0.2); /* Separador cuando abierto */
        }
        summary .chevron-icon {
            transition: transform 0.3s ease;
        }
        details[open] summary .chevron-icon {
            transform: rotate(90deg);
        }

        .container {
            display: flex;
            gap: 30px; /* Menos espacio para mejor uso del ancho */
            flex-wrap: wrap;
            padding: 25px; /* Padding interno del contenedor */
            background-color: #ffffff;
            border-top: none; /* Eliminar el borde superior duplicado */
            border-radius: 0 0 12px 12px; /* Solo esquinas inferiores redondeadas */
        }

        .formulario {
            flex: 1 1 500px; /* Base más flexible */
            background: #ffffff;
            border-left: 6px solid #1a73e8;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            padding: 30px;
            position: relative;
        }

        .badge {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #34a853;
            color: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .badge.show {
            opacity: 1;
            transform: translateY(0);
        }

        .preview {
            flex: 1 1 350px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            border-left: 6px solid #1a73e8;
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }

        .preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .preview h3 {
            margin-top: 0;
            font-size: 1.4rem;
            color: #1a73e8;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .preview p {
            margin: 12px 0;
            font-size: 1rem;
            color: #333;
        }

        .preview p strong {
            display: inline-block;
            width: 180px;
            color: #1a73e8;
        }

        .preview span {
            font-weight: 500;
            color: #555;
        }

        .preview-img {
            display: block;
            width: 100%;
            height: auto; /* Asegura que la imagen se adapte */
            margin-top: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            margin-top: 5px;
            border: 1px solid #b0c2d4; /* Borde más suave */
            border-radius: 6px;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.3);
            outline: none;
        }
        input[type="date"] {
            -webkit-appearance: none; /* Quitar estilo nativo en Webkit */
            -moz-appearance: none; /* Quitar estilo nativo en Mozilla */
            appearance: none;
            background-color: #fff;
            padding-right: 30px; /* Espacio para el icono del calendario */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="%231a73e8"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.11 0-1.99.89-1.99 2L2 21c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 18H4V8h16v13z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 20px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Más espacio entre botones */
            margin-top: 25px; /* Más margen superior */
            justify-content: center; /* Centrar botones */
        }

        button {
            flex: 1 1 auto; /* Permitir que los botones se adapten al contenido y se envuelvan */
            background: #1a73e8;
            color: #fff;
            border: none;
            padding: 14px 20px; /* Más padding */
            border-radius: 8px; /* Ligeramente más redondeado */
            cursor: pointer;
            font-weight: bold;
            font-size: 1.05rem; /* Un poco más grande */
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        button:hover {
            background: #155ab6;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        button.secondary {
            background: #34a853; /* Verde para acciones secundarias */
        }

        button.secondary:hover {
            background: #2c8c46;
        }
        
        button.signature-button {
            background: #8B5CF6; /* Púrpura para firma */
        }
        button.signature-button:hover {
            background: #7A3FEE;
        }

        button.mark-evaluated-btn {
            background: var(--accent-blue); /* Color distintivo para el botón de evaluación */
        }
        button.mark-evaluated-btn:hover {
            background: hsl(200, 70%, 45%); /* Tono más oscuro al pasar el mouse */
        }
        button.mark-evaluated-btn:disabled {
            background: #ccc; /* Gris para el botón deshabilitado */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        p.info {
            margin: 5px 0;
            font-weight: 500;
            color: #555;
        }

        /* Checkbox custom styling */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--primary-light);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .checkbox-item:hover {
            background-color: hsl(210, 16%, 88%);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue); /* Color del checkbox */
            cursor: pointer;
            margin-top: 0; /* Reset margin */
        }

        .checkbox-item.checked {
            background-color: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .checkbox-item.checked input[type="checkbox"] {
            accent-color: white; /* Color del checkmark cuando está seleccionado */
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para impresión */
        @media print {
            body {
                background: none;
                padding: 0;
                margin: 0;
            }
            header, footer, .main-content-wrapper .evaluation-counter, #buscador, .action-buttons, .back-to-dashboard-btn, .logout-btn, .filter-group {
                display: none !important; /* Ocultar elementos no deseados al imprimir */
            }
            .main-content-wrapper {
                margin: 0;
                padding: 0;
                width: 100%; /* Ocupar todo el ancho para impresión */
                max-width: none;
            }
            .estudiante {
                page-break-inside: avoid; /* Evitar que los formularios se corten al final de una página */
                margin-bottom: 20px; /* Espacio entre formularios impresos */
                border: 1px solid #ccc; /* Borde suave para cada formulario impreso */
                padding: 15px;
            }
            .estudiante summary {
                background: #e0e0e0 !important; /* Fondo más claro para impresión */
                color: #333 !important;
                border-bottom: 1px solid #ccc !important;
            }
            .estudiante details[open] summary .chevron-icon {
                display: none !important; /* Ocultar el icono de flecha al imprimir */
            }
            .estudiante details[open] .container {
                display: flex !important; /* Asegurar que el contenido se muestre */
                flex-direction: column !important;
                gap: 15px !important;
                padding: 15px !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            .estudiante .formulario, .estudiante .preview {
                flex: none !important; /* Quitar flexibilidad para impresión */
                width: 100% !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }
            .estudiante .form-actions {
                display: none !important; /* Ocultar botones de acción en impresión */
            }
            .estudiante .badge.show {
                display: none !important; /* Ocultar badge de "Guardado" */
            }
            .estudiante .preview-img {
                max-width: 200px; /* Reducir tamaño de la imagen de vista previa si está presente */
                height: auto;
            }
            /* Asegurar que los inputs y textareas muestren su valor como texto normal */
            input, textarea, select {
                border: none !important;
                box-shadow: none !important;
                background-color: transparent !important;
                -webkit-print-color-adjust: exact; /* Para imprimir colores de fondo */
                color-adjust: exact;
                padding: 0 !important;
                margin: 0 !important;
            }
            textarea {
                resize: none !important;
            }
            /* Mostrar valores de input/textarea como texto en impresión */
            input[type="text"], input[type="date"], select, textarea {
                border: none;
                box-shadow: none;
                background-color: transparent;
                -webkit-print-color-adjust: exact; /* Print exact background colors */
                color-adjust: exact;
                width: auto !important; /* Allow content to dictate width */
            }
            /* Ocultar elementos de UI específicos para impresión */
            .student-item-card .form-actions,
            .student-item-card .badge,
            .student-item-card .mark-evaluated-btn {
                display: none !important;
            }
        }


        /* Responsividad */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .main-content-wrapper {
                margin: 15px auto;
                padding: 0 10px;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .header-btn {
                position: static; /* Quitar posicionamiento absoluto */
                margin-bottom: 10px; /* Espacio entre botones */
                width: calc(100% - 40px); /* Ocupar casi todo el ancho */
                margin-left: auto;
                margin-right: auto;
                display: block;
                text-align: center;
            }
            .action-buttons button {
                width: 100%; /* Ajustar al 100% en móvil */
            }
            .filter-group {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .back-to-dashboard-btn { order: 1; }
            .logout-btn { order: 2; }
            header {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #buscador {
                max-width: 100%;
            }
            .container {
                flex-direction: column;
                gap: 20px;
                padding: 15px;
            }
            .formulario, .preview {
                flex: 1 1 100%; /* Ocupar todo el ancho */
                padding: 20px;
            }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 100%;
                font-size: 1rem;
                padding: 12px 15px;
            }
            .preview p strong {
                width: 120px; /* Reducir el ancho en móvil */
            }
        }

    </style>
</head>
<body>
    <header>
        <a href="{{ url_for('dashboard') }}" class="header-btn back-to-dashboard-btn">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="CardioHome Logo">
        <h1>{{ establecimiento_nombre }} — Formulario de Medicina Familiar</h1>
        <button class="header-btn logout-btn" onclick="cerrarSesion()">
            <i class="fas fa-sign-out-alt"></i> Cerrar sesión
        </button>
    </header>

    <div class="main-content-wrapper">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        
        <!-- Contador de evaluaciones -->
        <div class="evaluation-counter">
            <i class="fas fa-clipboard-check"></i>
            <span>Evaluaciones completadas para esta nómina: <strong id="completed-forms-count">{{ total_forms_completed_for_nomina }}</strong></span>
            <button onclick="window.location.reload();">Actualizar Conteo</button>
        </div>

        <!-- Nuevos botones de acción -->
        <div class="action-buttons">
            <button onclick="imprimirTodosLosFormularios()">
                <i class="fas fa-print"></i> Imprimir Formularios Visibles (HTML)
            </button>
            <button onclick="descargarExcelCompletados('{{ session['current_nomina_id'] }}', '{{ establecimiento_nombre }}')">
                <i class="fas fa-file-excel"></i> Descargar Excel de Evaluados
            </button>
            <button onclick="generarEImprimirPDFsVisibles('{{ session['current_nomina_id'] }}', '{{ establecimiento_nombre }}')">
                <i class="fas fa-file-pdf"></i> Generar y Abrir PDFs Visibles (para Imprimir)
            </button>
        </div>


        <input type="text" id="buscador" placeholder="Buscar estudiante por nombre..." oninput="aplicarFiltros()">

        <!-- Nuevo filtro de estado de evaluación -->
        <div class="filter-group">
            <label>
                <input type="radio" name="evaluation_filter" value="all" checked onchange="aplicarFiltros()"> Todos
            </label>
            <label>
                <input type="radio" name="evaluation_filter" value="evaluated" onchange="aplicarFiltros()"> Evaluados
            </label>
            <label>
                <input type="radio" name="evaluation_filter" value="not_evaluated" onchange="aplicarFiltros()"> No Evaluados
            </label>
        </div>


        {% if estudiantes %}
            {% for est in estudiantes %}
            <details class="estudiante" data-nombre="{{ est.nombre | lower }}" data-estudiante-id="{{ est.id }}" data-nomina-id="{{ session['current_nomina_id'] }}" data-evaluated-status="{{ 'true' if est.fecha_relleno is not none else 'false' }}">
                <summary>
                    <span>{{ est.nombre }} (RUT: {{ est.rut }}) - Edad: {{ est.edad }}</span>
                    <i class="fas fa-chevron-right chevron-icon"></i>
                </summary>
                <div class="container">
                    <div class="formulario">
                        <span class="badge">Guardado</span>
                        <form id="form-estudiante-{{ est.id }}" onsubmit="event.preventDefault(); submitForm(this);">
                            <!-- Campos ocultos para pasar el ID del estudiante y la nómina al backend -->
                            <input type="hidden" name="estudiante_id" value="{{ est.id }}">
                            <input type="hidden" name="nomina_id" value="{{ session['current_nomina_id'] }}">
                            
                            <!-- IDENTIFICACIÓN DEL ESTUDIANTE -->
                            <h3 class="section-title">Identificación del Estudiante</h3>
                            <label for="nombre_{{ est.id }}">Nombres y Apellidos:</label>
                            <input type="text" name="nombre" id="nombre_{{ est.id }}" class="form-control" value="{{ est.nombre }}" required readonly>
                            <input type="hidden" name="nombre_original" value="{{ est.nombre }}"> {# Campo oculto para compatibilidad #}


                            <label>Género:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.genero_f %}checked{% endif %}">
                                    <input type="checkbox" name="genero_f" id="genero_f_{{ est.id }}" value="Femenino" {% if est.genero_f %}checked{% endif %} onchange="handleGenderChange(this)"> Femenino
                                </label>
                                <label class="checkbox-item {% if est.genero_m %}checked{% endif %}">
                                    <input type="checkbox" name="genero_m" id="genero_m_{{ est.id }}" value="Masculino" {% if est.genero_m %}checked{% endif %} onchange="handleGenderChange(this)"> Masculino
                                </label>
                            </div>

                            <label for="rut_{{ est.id }}">RUN:</label>
                            <input type="text" name="rut" id="rut_{{ est.id }}" value="{{ est.rut }}" required readonly>
                            <input type="hidden" name="rut_original" value="{{ est.rut }}"> {# Campo oculto para compatibilidad #}


                            <label for="fecha_nacimiento_{{ est.id }}">Fecha de Nacimiento (dd/mm/aaaa):</label>
                            <input type="date" name="fecha_nacimiento" id="fecha_nacimiento_{{ est.id }}" value="{{ est.fecha_nacimiento }}" required readonly>
                            <input type="hidden" name="fecha_nacimiento_original" value="{{ est.fecha_nacimiento }}"> {# Campo oculto para compatibilidad #}

                            <label for="edad_{{ est.id }}">Edad (en años y meses):</label>
                            <input type="text" name="edad" id="edad_{{ est.id }}" value="{{ est.edad }}" readonly>
                            <input type="hidden" name="edad_original" value="{{ est.edad }}"> {# Campo oculto para compatibilidad #}


                            <label for="nacionalidad_{{ est.id }}">Nacionalidad:</label>
                            <input type="text" name="nacionalidad" id="nacionalidad_{{ est.id }}" value="{{ est.nacionalidad }}" readonly>
                            <input type="hidden" name="nacionalidad_original" value="{{ est.nacionalidad }}"> {# Campo oculto para compatibilidad #}


                            <label for="fecha_evaluacion_{{ est.id }}">Fecha Evaluación:</label>
                            <input type="date" name="fecha_evaluacion" id="fecha_evaluacion_{{ est.id }}" value="{{ est.fecha_evaluacion if est.fecha_evaluacion is not none else '' }}" required readonly>
                            
                            <!-- EXAMEN DEL ESTADO DE SALUD GENERAL DEL ESTUDIANTE -->
                            <h3 class="section-title">Examen del Estado de Salud General del Estudiante</h3>
                            <label for="diagnostico_1_{{ est.id }}">Diagnóstico (Trastorno, Déficit o Discapacidad):</label>
                            <input type="text" name="diagnostico_1" id="diagnostico_1_{{ est.id }}" value="{{ est.diagnostico_1 if est.diagnostico_1 is not none else '' }}" placeholder="Ej: Trastorno del Espectro Autista">

                            <label for="diagnostico_2_{{ est.id }}">Diagnóstico Específico:</label>
                            <select name="diagnostico_2" id="diagnostico_2_{{ est.id }}">
                                <option value="">Seleccione un diagnóstico</option>
                                <option value="TDA" {% if est.diagnostico_2 == 'TDA' %}selected{% endif %}>TDA</option>
                                <option value="TDAH" {% if est.diagnostico_2 == 'TDAH' %}selected{% endif %}>TDAH</option>
                                <option value="FIL" {% if est.diagnostico_2 == 'FIL' %}selected{% endif %}>FIL</option>
                                <option value="DIL" {% if est.diagnostico_2 == 'DIL' %}selected{% endif %}>DIL</option>
                            </select>

                            <label for="diagnostico_complementario_{{ est.id }}">Diagnóstico Complementario:</label>
                            <textarea name="diagnostico_complementario" id="diagnostico_complementario_{{ est.id }}" rows="3" placeholder="Notas adicionales sobre el diagnóstico complementario.">{{ est.diagnostico_complementario if est.diagnostico_complementario is not none else '' }}</textarea>

                            <label for="derivaciones_{{ est.id }}">Derivaciones:</label>
                            <textarea name="derivaciones" id="derivaciones_{{ est.id }}" rows="2" placeholder="Indique las derivaciones necesarias (ej: a especialista, terapia).">{{ est.derivaciones if est.derivaciones is not none else '' }}</textarea>

                            <label for="fecha_reevaluacion_select_{{ est.id }}">Fecha Reevaluación (años):</label>
                            <select name="fecha_reevaluacion_select" id="fecha_reevaluacion_select_{{ est.id }}" onchange="setFechaReevaluacion(this)">
                                <option value="">Seleccione años</option>
                                <option value="1" {% if est.fecha_reevaluacion_select == '1' %}selected{% endif %}>1 año</option>
                                <option value="2" {% if est.fecha_reevaluacion_select == '2' %}selected{% endif %}>2 años</option>
                                <option value="3" {% if est.fecha_reevaluacion_select == '3' %}selected{% endif %}>3 años</option>
                                <option value="4" {% if est.fecha_reevaluacion_select == '4' %}selected{% endif %}>4 años</option>
                                <option value="5" {% if est.fecha_reevaluacion_select == '5' %}selected{% endif %}>5 años</option>
                            </select>
                            <label for="fecha_reevaluacion_input_{{ est.id }}">Fecha de reevaluación (calculada):</label>
                            <input type="date" name="fecha_reevaluacion" id="fecha_reevaluacion_input_{{ est.id }}" value="{{ est.fecha_reevaluacion if est.fecha_reevaluacion is not none else '' }}" readonly>
                            <input type="hidden" name="fecha_reevaluacion_pdf" id="fecha_reevaluacion_pdf_{{ est.id }}" value=""> {# Hidden field for PDF format #}

                            <label for="observaciones_completas_{{ est.id }}">Observaciones (se autocompletan en campos separados en el PDF):</label>
                            <textarea name="observaciones_completas" id="observaciones_completas_{{ est.id }}" rows="7" placeholder="Escriba aquí todas las observaciones. El texto se dividirá automáticamente en OBS1 a OBS7 para el PDF." oninput="splitObservations(this)">{{ est.observacion_1 if est.observacion_1 is not none else '' }}{{ est.observacion_2 if est.observacion_2 is not none else '' }}{{ est.observacion_3 if est.observacion_3 is not none else '' }}{{ est.observacion_4 if est.observacion_4 is not none else '' }}{{ est.observacion_5 if est.observacion_5 is not none else '' }}{{ est.observacion_6 if est.observacion_6 is not none else '' }}{{ est.observacion_7 if est.observacion_7 is not none else '' }}</textarea>
                            <!-- Campos ocultos para las observaciones divididas (para el backend) -->
                            <input type="hidden" name="observacion_1" id="observacion_1_{{ est.id }}" value="{{ est.observacion_1 if est.observacion_1 is not none else '' }}">
                            <input type="hidden" name="observacion_2" id="observacion_2_{{ est.id }}" value="{{ est.observacion_2 if est.observacion_2 is not none else '' }}">
                            <input type="hidden" name="observacion_3" id="observacion_3_{{ est.id }}" value="{{ est.observacion_3 if est.observacion_3 is not none else '' }}">
                            <input type="hidden" name="observacion_4" id="observacion_4_{{ est.id }}" value="{{ est.observacion_4 if est.observacion_4 is not none else '' }}">
                            <input type="hidden" name="observacion_5" id="observacion_5_{{ est.id }}" value="{{ est.observacion_5 if est.observacion_5 is not none else '' }}">
                            <input type="hidden" name="observacion_6" id="observacion_6_{{ est.id }}" value="{{ est.observacion_6 if est.observacion_6 is not none else '' }}">
                            <input type="hidden" name="observacion_7" id="observacion_7_{{ est.id }}" value="{{ est.observacion_7 if est.observacion_7 is not none else '' }}">

                            <!-- EXAMEN FÍSICO -->
                            <h3 class="section-title">Examen Físico</h3>
                            <label for="altura_{{ est.id }}">Altura (cm):</label>
                            <input type="number" name="altura" id="altura_{{ est.id }}" step="0.1" min="0" value="{{ est.altura if est.altura is not none else '' }}" placeholder="Ej: 165.5" oninput="calculateIMC(this.form)">
                            <label for="peso_{{ est.id }}">Peso (kg):</label>
                            <input type="number" name="peso" id="peso_{{ est.id }}" step="0.1" min="0" value="{{ est.peso if est.peso is not none else '' }}" placeholder="Ej: 60.2" oninput="calculateIMC(this.form)">
                            <label for="imc_{{ est.id }}">I.M.C:</label>
                            <input type="text" name="imc" id="imc_{{ est.id }}" value="{{ est.imc if est.imc is not none else '' }}" readonly>
                            <label for="clasificacion_imc_{{ est.id }}">Clasificación:</label>
                            <input type="text" name="clasificacion_imc" id="clasificacion_imc_{{ est.id }}" value="{{ est.clasificacion_imc if est.clasificacion_imc is not none else '' }}" readonly>

                            <!-- ANTECEDENTES PERINATALES -->
                            <h3 class="section-title">Antecedentes Perinatales</h3>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.check_cesarea %}checked{% endif %}">
                                    <input type="checkbox" name="check_cesarea" id="check_cesarea_{{ est.id }}" value="CESAREA" {% if est.check_cesarea %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Cesárea
                                </label>
                                <label class="checkbox-item {% if est.check_atermino %}checked{% endif %}">
                                    <input type="checkbox" name="check_atermino" id="check_atermino_{{ est.id }}" value="A_TERMINO" {% if est.check_atermino %}checked{% endif %} onchange="updateCheckboxStyle(this)"> A Término
                                </label>
                                <label class="checkbox-item {% if est.check_vaginal %}checked{% endif %}">
                                    <input type="checkbox" name="check_vaginal" id="check_vaginal_{{ est.id }}" value="VAGINAL" {% if est.check_vaginal %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Vaginal
                                </label>
                                <label class="checkbox-item {% if est.check_prematuro %}checked{% endif %}">
                                    <input type="checkbox" name="check_prematuro" id="check_prematuro_{{ est.id }}" value="PREMATURO" {% if est.check_prematuro %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Prematuro
                                </label>
                                <label class="checkbox-item {% if est.check_acorde %}checked{% endif %}">
                                    <input type="checkbox" name="check_acorde" id="check_acorde_{{ est.id }}" value="LOGRADO_ACORDE_A_LA_EDAD" {% if est.check_acorde %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Logrado Acorde a la Edad (DSM)
                                </label>
                                <label class="checkbox-item {% if est.check_retrasogeneralizado %}checked{% endif %}">
                                    <input type="checkbox" name="check_retrasogeneralizado" id="check_retrasogeneralizado_{{ est.id }}" value="RETRASO_GENERALIZADO_DEL_DESARROLLO" {% if est.check_retrasogeneralizado %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Retraso Generalizado del Desarrollo
                                </label>
                            </div>

                            <!-- ANTECEDENTES PERSONALES (VACUNAS, ALERGIAS, HOSPITALIZACIONES/CIRUGIAS) -->
                            <h3 class="section-title">Antecedentes Personales</h3>
                            <label>Vacunas:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.check_esquemac %}checked{% endif %}">
                                    <input type="checkbox" name="check_esquemac" id="check_esquemac_{{ est.id }}" value="ESQUEMA_COMPLETO" {% if est.check_esquemac %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Esquema Completo
                                </label>
                                <label class="checkbox-item {% if est.check_esquemai %}checked{% endif %}">
                                    <input type="checkbox" name="check_esquemai" id="check_esquemai_{{ est.id }}" value="ESQUEMA_INCOMPLETO" {% if est.check_esquemai %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Esquema Incompleto
                                </label>
                            </div>
                            <label>Alergias:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.check_alergiano %}checked{% endif %}">
                                    <input type="checkbox" name="check_alergiano" id="check_alergiano_{{ est.id }}" value="NO_ALERGIAS" {% if est.check_alergiano %}checked{% endif %} onchange="updateCheckboxStyle(this)"> No
                                </label>
                                <label class="checkbox-item {% if est.check_alergiasi %}checked{% endif %}">
                                    <input type="checkbox" name="check_alergiasi" id="check_alergiasi_{{ est.id }}" value="SI_ALERGIAS" {% if est.check_alergiasi %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Sí
                                </label>
                            </div>
                            <label>Hospitalizaciones/Cirugías:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.check_cirugiano %}checked{% endif %}">
                                    <input type="checkbox" name="check_cirugiano" id="check_cirugiano_{{ est.id }}" value="NO_CIRUGIAS" {% if est.check_cirugiano %}checked{% endif %} onchange="updateCheckboxStyle(this)"> No
                                </label>
                                <label class="checkbox-item {% if est.check_cirugiasi %}checked{% endif %}">
                                    <input type="checkbox" name="check_cirugiasi" id="check_cirugiasi_{{ est.id }}" value="SI_CIRUGIAS" {% if est.check_cirugiasi %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Sí
                                </label>
                            </div>

                            <!-- VISIÓN Y AUDICIÓN -->
                            <h3 class="section-title">Visión y Audición</h3>
                            <label>Visión:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.check_visionsinalteracion %}checked{% endif %}">
                                    <input type="checkbox" name="check_visionsinalteracion" id="check_visionsinalteracion_{{ est.id }}" value="SIN_ALTERACION_VISION" {% if est.check_visionsinalteracion %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Sin Alteración
                                </label>
                                <label class="checkbox-item {% if est.check_visionrefraccion %}checked{% endif %}">
                                    <input type="checkbox" name="check_visionrefraccion" id="check_visionrefraccion_{{ est.id }}" value="VICIOS_DE_REFRACCION" {% if est.check_visionrefraccion %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Vicios de Refracción
                                </label>
                            </div>
                            <label>Audición:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.check_audicionnormal %}checked{% endif %}">
                                    <input type="checkbox" name="check_audicionnormal" id="check_audicionnormal_{{ est.id }}" value="NORMAL_AUDICION" {% if est.check_audicionnormal %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Normal
                                </label>
                                <label class="checkbox-item {% if est.check_hipoacusia %}checked{% endif %}">
                                    <input type="checkbox" name="check_hipoacusia" id="check_hipoacusia_{{ est.id }}" value="HIPOACUSIA" {% if est.check_hipoacusia %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Hipoacusia
                                </label>
                                <label class="checkbox-item {% if est.check_tapondecerumen %}checked{% endif %}">
                                    <input type="checkbox" name="check_tapondecerumen" id="check_tapondecerumen_{{ est.id }}" value="TAPON_DE_CERUMEN" {% if est.check_tapondecerumen %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Tapón de Cerumen
                                </label>
                            </div>

                            <!-- SALUD BUCODENTAL -->
                            <h3 class="section-title">Salud Bucodental</h3>
                            <div class="checkbox-group">
                                <label class="checkbox-item {% if est.check_sinhallazgos %}checked{% endif %}">
                                    <input type="checkbox" name="check_sinhallazgos" id="check_sinhallazgos_{{ est.id }}" value="SIN_HALLAZGOS" {% if est.check_sinhallazgos %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Sin Hallazgos
                                </label>
                                <label class="checkbox-item {% if est.check_caries %}checked{% endif %}">
                                    <input type="checkbox" name="check_caries" id="check_caries_{{ est.id }}" value="CARIES" {% if est.check_caries %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Caries
                                </label>
                                <label class="checkbox-item {% if est.check_apinamientodental %}checked{% endif %}">
                                    <input type="checkbox" name="check_apinamientodental" id="check_apinamientodental_{{ est.id }}" value="APINAMIENTO_DENTAL" {% if est.check_apinamientodental %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Apiñamiento Dental
                                </label>
                                <label class="checkbox-item {% if est.check_retenciondental %}checked{% endif %}">
                                    <input type="checkbox" name="check_retenciondental" id="check_retenciondental_{{ est.id }}" value="RETENCION_DENTAL" {% if est.check_retenciondental %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Retención Dental
                                </label>
                                <label class="checkbox-item {% if est.check_frenillolingual %}checked{% endif %}">
                                    <input type="checkbox" name="check_frenillolingual" id="check_frenillolingual_{{ est.id }}" value="FRENILLO_LINGUAL" {% if est.check_frenillolingual %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Frenillo Lingual
                                </label>
                                <label class="checkbox-item {% if est.check_hipertrofia %}checked{% endif %}">
                                    <input type="checkbox" name="check_hipertrofia" id="check_hipertrofia_{{ est.id }}" value="HIPERTROFIA_AMIGDALINA" {% if est.check_hipertrofia %}checked{% endif %} onchange="updateCheckboxStyle(this)"> Hipertrofia Amigdalina
                                </label>
                            </div>

                            <div class="button-group">
                                <button type="submit">
                                    <i class="fas fa-file-pdf"></i> Guardar y Generar PDF
                                </button>
                                <button type="button" class="secondary" onclick="enviarADrive(this.form)">
                                    <i class="fab fa-google-drive"></i> Enviar a Drive
                                </button>
                                <button type="button" class="secondary signature-button" onclick="insertarFirma()">
                                    <i class="fas fa-signature"></i> Insertar Firma
                                </button>
                                <button type="button" class="mark-evaluated-btn" 
                                    {% if est.fecha_relleno is not none %}disabled{% endif %} 
                                    onclick="marcarComoEvaluado(this)">
                                    <i class="fas fa-check-circle"></i> 
                                    {% if est.fecha_relleno is not none %}Evaluado{% else %}Marcar como Evaluado{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="preview">
                        <h3>Vista Previa</h3>
                        <p><strong>Nombre:</strong> <span class="prev-nombre">{{ est.nombre }}</span></p>
                        <p><strong>RUT:</strong> <span class="prev-rut">{{ est.rut }}</span></p>
                        <p><strong>Género:</strong> <span class="prev-genero">{{ 'Femenino' if est.genero_f else 'Masculino' if est.genero_m else '-' }}</span></p>
                        <p><strong>Fecha Nacimiento:</strong> <span class="prev-fecha-nacimiento">{{ est.fecha_nacimiento_formato }}</span></p>
                        <p><strong>Edad:</strong> <span class="prev-edad">{{ est.edad }}</span></p>
                        <p><strong>Nacionalidad:</strong> <span class="prev-nacionalidad">{{ est.nacionalidad }}</span></p>
                        <p><strong>Fecha Evaluación:</strong> <span class="prev-fecha-evaluacion">{{ est.fecha_evaluacion if est.fecha_evaluacion is not none else '-' }}</span></p>
                        <p><strong>Diagnóstico 1:</strong> <span class="prev-diagnostico-1">{{ est.diagnostico_1 if est.diagnostico_1 is not none else '-' }}</span></p>
                        <p><strong>Diagnóstico 2:</strong> <span class="prev-diagnostico-2">{{ est.diagnostico_2 if est.diagnostico_2 is not none else '-' }}</span></p>
                        <p><strong>Diagnóstico Comp.:</strong> <span class="prev-diagnostico-complementario">{{ est.diagnostico_complementario if est.diagnostico_complementario is not none else '-' }}</span></p>
                        <p><strong>Derivaciones:</strong> <span class="prev-derivaciones">{{ est.derivaciones if est.derivaciones is not none else '-' }}</span></p>
                        <p><strong>Fecha Reevaluación:</strong> <span class="prev-fecha-reevaluacion">
                            {% if est.fecha_reevaluacion %}
                                {% set date_obj = est.fecha_reevaluacion.split('-') %}
                                {{ date_obj[2] }}/{{ date_obj[1] }}/{{ date_obj[0] }}
                            {% else %}
                                -
                            {% endif %}
                        </span></p>
                        <p><strong>Altura:</strong> <span class="prev-altura">{{ est.altura if est.altura is not none else '-' }}</span> cm</p>
                        <p><strong>Peso:</strong> <span class="prev-peso">{{ est.peso if est.peso is not none else '-' }}</span> kg</p>
                        <p><strong>IMC:</strong> <span class="prev-imc">{{ est.imc if est.imc is not none else '-' }}</span></p>
                        <p><strong>Clasificación:</strong> <span class="prev-clasificacion">{{ est.clasificacion_imc if est.clasificacion_imc is not none else '-' }}</span></p>
                        <p><strong>Observaciones:</strong> <span class="prev-observaciones">{{ est.observacion_1 if est.observacion_1 is not none else '' }}{{ est.observacion_2 if est.observacion_2 is not none else '' }}{{ est.observacion_3 if est.observacion_3 is not none else '' }}{{ est.observacion_4 if est.observacion_4 is not none else '' }}{{ est.observacion_5 if est.observacion_5 is not none else '' }}{{ est.observacion_6 if est.observacion_6 is not none else '' }}{{ est.observacion_7 if est.observacion_7 is not none else '' }}</span></p>
                        
                        <!-- Checkbox Previews -->
                        <div class="checkbox-preview-group">
                            <strong>Antecedentes Perinatales:</strong>
                            <p>Cesárea: <span class="prev-check-cesarea">{{ 'Sí' if est.check_cesarea else 'No' }}</span></p>
                            <p>A Término: <span class="prev-check-atermino">{{ 'Sí' if est.check_atermino else 'No' }}</span></p>
                            <p>Vaginal: <span class="prev-check-vaginal">{{ 'Sí' if est.check_vaginal else 'No' }}</span></p>
                            <p>Prematuro: <span class="prev-check-prematuro">{{ 'Sí' if est.check_prematuro else 'No' }}</span></p>
                            <p>Acorde a Edad (DSM): <span class="prev-check-acorde">{{ 'Sí' if est.check_acorde else 'No' }}</span></p>
                            <p>Retraso Generalizado del Desarrollo: <span class="prev-check-retrasogeneralizado">{{ 'Sí' if est.check_retrasogeneralizado else 'No' }}</span></p>
                            
                            <strong>Vacunas:</strong>
                            <p>Esquema Completo: <span class="prev-check-esquemac">{{ 'Sí' if est.check_esquemac else 'No' }}</span></p>
                            <p>Esquema Incompleto: <span class="prev-check-esquemai">{{ 'Sí' if est.check_esquemai else 'No' }}</span></p>

                            <strong>Alergias:</strong>
                            <p>No Alergias: <span class="prev-check-alergiano">{{ 'Sí' if est.check_alergiano else 'No' }}</span></p>
                            <p>Sí Alergias: <span class="prev-check-alergiasi">{{ 'Sí' if est.check_alergiasi else 'No' }}</span></p>

                            <strong>Hospitalizaciones/Cirugías:</strong>
                            <p>No Cirugías: <span class="prev-check-cirugiano">{{ 'Sí' if est.check_cirugiano else 'No' }}</span></p>
                            <p>Sí Cirugías: <span class="prev-check-cirugiasi">{{ 'Sí' if est.check_cirugiasi else 'No' }}</span></p>

                            <strong>Visión:</strong>
                            <p>Sin Alteración: <span class="prev-check-visionsinalteracion">{{ 'Sí' if est.check_visionsinalteracion else 'No' }}</span></p>
                            <p>Vicios de Refracción: <span class="prev-check-visionrefraccion">{{ 'Sí' if est.check_visionrefraccion else 'No' }}</span></p>

                            <strong>Audición:</strong>
                            <p>Normal Audición: <span class="prev-check-audicionnormal">{{ 'Sí' if est.check_audicionnormal else 'No' }}</span></p>
                            <p>Hipoacusia: <span class="prev-check-hipoacusia">{{ 'Sí' if est.check_hipoacusia else 'No' }}</span></p>
                            <p>Tapón de Cerumen: <span class="prev-check-tapondecerumen">{{ 'Sí' if est.check_tapondecerumen else 'No' }}</span></p>

                            <strong>Salud Bucodental:</strong>
                            <p>Sin Hallazgos: <span class="prev-check-sinhallazgos">{{ 'Sí' if est.check_sinhallazgos else 'No' }}</span></p>
                            <p>Caries: <span class="prev-check-caries">{{ 'Sí' if est.check_caries else 'No' }}</span></p>
                            <p>Apiñamiento Dental: <span class="prev-check-apinamientodental">{{ 'Sí' if est.check_apinamientodental else 'No' }}</span></p>
                            <p>Retención Dental: <span class="prev-check-retenciondental">{{ 'Sí' if est.check_retenciondental else 'No' }}</span></p>
                            <p>Frenillo Lingual: <span class="prev-check-frenillolingual">{{ 'Sí' if est.check_frenillolingual else 'No' }}</span></p>
                            <p>Hipertrofia Amigdalina: <span class="prev-check-hipertrofia">{{ 'Sí' if est.check_hipertrofia else 'No' }}</span></p>
                        </div>

                        <img src="/static/formulario_muestra.png" alt="Ejemplo Formulario" class="preview-img" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=Imagen+No+Disponible';" />

                        <button onclick="window.print()" style="margin-top: 20px; width: 100%;">
                            <i class="fas fa-print"></i> Imprimir Vista Previa
                        </button>
                    </div>
                </div>
            </details>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #888; font-size: 1.1rem; margin-top: 50px;">No hay estudiantes en esta nómina o ha ocurrido un error al cargarlos.</p>
        {% endif %}
    </div>

    <footer>
        © 2025 CardioHome · Todos los derechos reservados.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar filtros y previsualizaciones al cargar
            aplicarFiltros(); // Aplica el filtro inicial (Todos)
            document.querySelectorAll('.formulario form').forEach(form => {
                // Autocompletar Fecha Evaluación con la fecha de hoy
                const fechaEvaluacionInput = form.querySelector('input[name="fecha_evaluacion"]');
                if (fechaEvaluacionInput && !fechaEvaluacionInput.value) {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    fechaEvaluacionInput.value = `${yyyy}-${mm}-${dd}`;
                }

                // Asegurarse de que el textarea de observaciones combinadas tenga el valor inicial
                const obs1 = form.querySelector('input[name="observacion_1"]').value || '';
                const obs2 = form.querySelector('input[name="observacion_2"]').value || '';
                const obs3 = form.querySelector('input[name="observacion_3"]').value || '';
                const obs4 = form.querySelector('input[name="observacion_4"]').value || '';
                const obs5 = form.querySelector('input[name="observacion_5"]').value || '';
                const obs6 = form.querySelector('input[name="observacion_6"]').value || '';
                const obs7 = form.querySelector('input[name="observacion_7"]').value || '';
                const observacionesCompletas = form.querySelector('textarea[name="observaciones_completas"]');
                if (observacionesCompletas) {
                    observacionesCompletas.value = obs1 + obs2 + obs3 + obs4 + obs5 + obs6 + obs7;
                }

                updatePreview(form); // Actualiza la vista previa con los valores iniciales
                
                // Si la fecha de reevaluación ya tiene un valor, no sobrescribir con el selector de años
                const fechaReevaluacionInput = form.querySelector('input[name="fecha_reevaluacion"]');
                const selectPlazo = form.querySelector('select[name="fecha_reevaluacion_select"]');
                if (selectPlazo && !fechaReevaluacionInput.value && selectPlazo.value) {
                    setFechaReevaluacion(selectPlazo);
                }
                
                // Calcular IMC inicial
                calculateIMC(form);

                // Inicializar estados de checkboxes
                form.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(checkbox => {
                    updateCheckboxStyle(checkbox);
                });
            });

            // Event listener para el buscador
            const buscador = document.getElementById('buscador');
            if (buscador) {
                buscador.addEventListener('input', aplicarFiltros);
            }

            // Event listener para los radio buttons de filtro
            document.querySelectorAll('input[name="evaluation_filter"]').forEach(radio => {
                radio.addEventListener('change', aplicarFiltros);
            });
        });

        function cerrarSesion() {
            window.location.href = "/logout";
        }

        // Manejo de cambio de género (para asegurar solo uno seleccionado)
        function handleGenderChange(changedCheckbox) {
            const form = changedCheckbox.closest('form');
            const estudianteId = form.querySelector('input[name="estudiante_id"]').value;
            const generoF = form.querySelector(`#genero_f_${estudianteId}`);
            const generoM = form.querySelector(`#genero_m_${estudianteId}`);

            if (changedCheckbox === generoF && generoF.checked) {
                generoM.checked = false;
                updateCheckboxStyle(generoM); // Update style for the other checkbox
            } else if (changedCheckbox === generoM && generoM.checked) {
                generoF.checked = false;
                updateCheckboxStyle(generoF); // Update style for the other checkbox
            }
            // Actualizar la clase 'checked' visualmente para el checkbox que cambió
            updateCheckboxStyle(changedCheckbox);
            updatePreview(form);
        }

        // Función para actualizar el estilo del checkbox
        function updateCheckboxStyle(checkbox) {
            if (checkbox.checked) {
                checkbox.closest('.checkbox-item').classList.add('checked');
            } else {
                checkbox.closest('.checkbox-item').classList.remove('checked');
            }
        }

        function setFechaReevaluacion(select) {
            const anos = parseInt(select.value);
            const form = select.closest('form');
            const fechaReevaluacionInput = form.querySelector('input[name="fecha_reevaluacion"]');
            const fechaReevaluacionPdfInput = form.querySelector('input[name="fecha_reevaluacion_pdf"]');
            const fechaEvaluacionInput = form.querySelector('input[name="fecha_evaluacion"]');
            
            if (!fechaEvaluacionInput.value) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Fecha de Evaluación Requerida',
                    text: 'Por favor, asegúrese de que la "Fecha Evaluación" esté presente para calcular la fecha de reevaluación.',
                    confirmButtonText: 'Entendido'
                });
                fechaReevaluacionInput.value = '';
                fechaReevaluacionPdfInput.value = '';
                updatePreview(form);
                return;
            }

            if (!isNaN(anos) && anos > 0) {
                const evalDate = new Date(fechaEvaluacionInput.value);
                const futureDate = new Date(evalDate.getFullYear() + anos, evalDate.getMonth(), evalDate.getDate()); 

                const year = futureDate.getFullYear();
                const month = String(futureDate.getMonth() + 1).padStart(2, '0');
                const day = String(futureDate.getDate()).padStart(2, '0');

                fechaReevaluacionInput.value = `${year}-${month}-${day}`; 
                fechaReevaluacionPdfInput.value = `${day}/${month}/${year}`; // Formato DD/MM/YYYY para PDF
            } else {
                fechaReevaluacionInput.value = ''; 
                fechaReevaluacionPdfInput.value = '';
            }
            updatePreview(form); 
        }

        function calculateIMC(form) {
            const alturaCm = parseFloat(form.querySelector('input[name="altura"]').value);
            const pesoKg = parseFloat(form.querySelector('input[name="peso"]').value);
            const imcInput = form.querySelector('input[name="imc"]');
            const clasificacionInput = form.querySelector('input[name="clasificacion_imc"]'); // Corrected name
            const generoF = form.querySelector(`input[name="genero_f"]`).checked;
            const generoM = form.querySelector(`input[name="genero_m"]`).checked;
            
            let gender = null;
            if (generoF) gender = 'F';
            else if (generoM) gender = 'M';

            if (isNaN(alturaCm) || isNaN(pesoKg) || alturaCm <= 0 || pesoKg <= 0) {
                imcInput.value = '';
                clasificacionInput.value = '';
                updatePreview(form);
                return;
            }

            const alturaM = alturaCm / 100; // Convertir cm a metros
            const imc = pesoKg / (alturaM * alturaM);
            imcInput.value = imc.toFixed(2); // Mostrar con 2 decimales
            classifyIMC(imc, gender, clasificacionInput);
            updatePreview(form);
        }

        function classifyIMC(imc, gender, clasificacionInput) {
            // Clasificación de IMC simplificada para adultos.
            // Para pacientes pediátricos, se requiere una clasificación más compleja
            // basada en percentiles de edad y sexo. Esta es una categorización general.
            let classification = '';
            if (imc < 18.5) {
                classification = 'Bajo peso';
            } else if (imc >= 18.5 && imc < 25) {
                classification = 'Peso normal';
            } else if (imc >= 25 && imc < 30) {
                classification = 'Sobrepeso';
            } else if (imc >= 30 && imc < 35) {
                classification = 'Obesidad Clase I';
            } else if (imc >= 35 && imc < 40) {
                classification = 'Obesidad Clase II';
            } else {
                classification = 'Obesidad Clase III';
            }
            clasificacionInput.value = classification;
        }

        // Función para dividir el texto de observaciones en campos ocultos para el PDF
        function splitObservations(textarea) {
            const fullText = textarea.value;
            const maxCharsPerField = 200; // Ajusta este valor según el espacio en tu PDF
            let currentText = fullText;

            for (let i = 1; i <= 7; i++) {
                const hiddenField = textarea.form.querySelector(`input[name="observacion_${i}"]`);
                if (hiddenField) {
                    if (currentText.length > 0) {
                        hiddenField.value = currentText.substring(0, maxCharsPerField);
                        currentText = currentText.substring(maxCharsPerField);
                    } else {
                        hiddenField.value = ''; // Limpiar campos subsiguientes si no hay más texto
                    }
                }
            }
            updatePreview(textarea.form);
        }


        function updatePreview(form) {
            const container = form.closest('.container');
            if (!container) return; 

            // Get the corresponding preview elements using the form's parent container
            const previewSection = container.querySelector('.preview');

            previewSection.querySelector('.prev-nombre').textContent = form.nombre.value;
            previewSection.querySelector('.prev-rut').textContent = form.rut.value;
            
            const estudianteId = form.querySelector('input[name="estudiante_id"]').value;
            const generoF = form.querySelector(`#genero_f_${estudianteId}`).checked;
            const generoM = form.querySelector(`#genero_m_${estudianteId}`).checked;
            previewSection.querySelector('.prev-genero').textContent = generoF ? 'Femenino' : (generoM ? 'Masculino' : '-');

            previewSection.querySelector('.prev-fecha-nacimiento').textContent = form.fecha_nacimiento.value;
            previewSection.querySelector('.prev-edad').textContent = form.edad.value;
            previewSection.querySelector('.prev-nacionalidad').textContent = form.nacionalidad.value;
            previewSection.querySelector('.prev-fecha-evaluacion').textContent = form.fecha_evaluacion.value;
            
            previewSection.querySelector('.prev-diagnostico-1').textContent = form.diagnostico_1 ? form.diagnostico_1.value : '-';
            previewSection.querySelector('.prev-diagnostico-2').textContent = form.diagnostico_2 ? form.diagnostico_2.value : '-';
            previewSection.querySelector('.prev-diagnostico-complementario').textContent = form.diagnostico_complementario ? form.diagnostico_complementario.value : '-';
            previewSection.querySelector('.prev-derivaciones').textContent = form.derivaciones ? form.derivaciones.value : '-';
            
            const fechaReevaluacionInput = form.querySelector('input[name="fecha_reevaluacion"]');
            if (fechaReevaluacionInput && fechaReevaluacionInput.value) {
                const [year, month, day] = fechaReevaluacionInput.value.split('-');
                previewSection.querySelector('.prev-fecha-reevaluacion').textContent = `${day}/${month}/${year}`;
            } else {
                previewSection.querySelector('.prev-fecha-reevaluacion').textContent = '-';
            }

            previewSection.querySelector('.prev-altura').textContent = form.altura ? form.altura.value : '-';
            previewSection.querySelector('.prev-peso').textContent = form.peso ? form.peso.value : '-';
            previewSection.querySelector('.prev-imc').textContent = form.imc ? form.imc.value : '-';
            previewSection.querySelector('.prev-clasificacion').textContent = form.clasificacion_imc ? form.clasificacion_imc.value : '-'; // Corrected name

            // Observaciones
            const obsText = (form.querySelector(`input[name="observacion_1"]`).value || '') +
                            (form.querySelector(`input[name="observacion_2"]`).value || '') +
                            (form.querySelector(`input[name="observacion_3"]`).value || '') +
                            (form.querySelector(`input[name="observacion_4"]`).value || '') +
                            (form.querySelector(`input[name="observacion_5"]`).value || '') +
                            (form.querySelector(`input[name="observacion_6"]`).value || '') +
                            (form.querySelector(`input[name="observacion_7"]`).value || '');
            previewSection.querySelector('.prev-observaciones').textContent = obsText || '-';


            // Checkbox Previews (using the actual checkbox state)
            previewSection.querySelector('.prev-check-cesarea').textContent = form.querySelector(`#check_cesarea_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-atermino').textContent = form.querySelector(`#check_atermino_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-vaginal').textContent = form.querySelector(`#check_vaginal_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-prematuro').textContent = form.querySelector(`#check_prematuro_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-acorde').textContent = form.querySelector(`#check_acorde_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-retrasogeneralizado').textContent = form.querySelector(`#check_retrasogeneralizado_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-esquemac').textContent = form.querySelector(`#check_esquemac_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-esquemai').textContent = form.querySelector(`#check_esquemai_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-alergiano').textContent = form.querySelector(`#check_alergiano_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-alergiasi').textContent = form.querySelector(`#check_alergiasi_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-cirugiano').textContent = form.querySelector(`#check_cirugiano_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-cirugiasi').textContent = form.querySelector(`#check_cirugiasi_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-visionsinalteracion').textContent = form.querySelector(`#check_visionsinalteracion_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-visionrefraccion').textContent = form.querySelector(`#check_visionrefraccion_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-hipoacusia').textContent = form.querySelector(`#check_hipoacusia_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-retenciondental').textContent = form.querySelector(`#check_retenciondental_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-hipertrofia').textContent = form.querySelector(`#check_hipertrofia_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-frenillolingual').textContent = form.querySelector(`#check_frenillolingual_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-sinhallazgos').textContent = form.querySelector(`#check_sinhallazgos_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-caries').textContent = form.querySelector(`#check_caries_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-audicionnormal').textContent = form.querySelector(`#check_audicionnormal_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-tapondecerumen').textContent = form.querySelector(`#check_tapondecerumen_${estudianteId}`).checked ? 'Sí' : 'No';
            previewSection.querySelector('.prev-check-apinamientodental').textContent = form.querySelector(`#check_apinamientodental_${estudianteId}`).checked ? 'Sí' : 'No';


            const badge = form.closest('.formulario').querySelector('.badge');
            if (badge) {
                badge.classList.add('show');
                badge.textContent = "Modificando..."; 
                clearTimeout(badge.timeout);
                badge.timeout = setTimeout(() => {
                    badge.textContent = "Guardado";
                }, 800);
            }
        }

        async function submitForm(form) {
            const formData = new FormData(form);

            // Manually set checkbox values if they are unchecked, as FormData doesn't include them
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                // If a checkbox is not checked, explicitly set its value in formData to an empty string
                // This ensures Flask receives a value for all checkbox names, allowing proper update to false/null
                if (!checkbox.checked) {
                    formData.set(checkbox.name, ''); 
                }
            });

            // Ensure fecha_reevaluacion_pdf is set from the hidden input
            const fechaReevaluacionPdfInput = form.querySelector('input[name="fecha_reevaluacion_pdf"]');
            if (fechaReevaluacionPdfInput) {
                formData.set('fecha_reevaluacion_pdf', fechaReevaluacionPdfInput.value);
            }

            // Debugging: Log FormData content
            console.log('FormData content before sending (submitForm):');
            for (let pair of formData.entries()) {
                console.log(pair[0]+ ': ' + pair[1]); 
            }

            Swal.fire({
                title: 'Guardando...',
                text: 'Por favor, espera.',
                didOpen: () => {
                    Swal.showLoading();
                },
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            try {
                const response = await fetch('/marcar_evaluado', {
                    method: 'POST',
                    body: formData // Send as FormData, Flask will use request.form
                });
                const data = await response.json(); // Flask still returns JSON

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Guardado!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    // Update UI as before
                    const studentDetail = form.closest('details.estudiante');
                    if (studentDetail) {
                        studentDetail.setAttribute('data-evaluated-status', 'true');
                        const summary = studentDetail.querySelector('summary');
                        const summaryText = summary.querySelector('span');
                        
                        const fechaRelleno = new Date().toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        const nombreEstudiante = formData.get('nombre');
                        const rutEstudiante = formData.get('rut');
                        const edadEstudiante = formData.get('edad');
                        summaryText.textContent = `${nombreEstudiante} (RUT: ${rutEstudiante}) - Edad: ${edadEstudiante} - Completado el ${fechaRelleno}`;
                        
                        const markEvaluatedBtn = form.querySelector('.mark-evaluated-btn');
                        if (markEvaluatedBtn) {
                            markEvaluatedBtn.disabled = true;
                            markEvaluatedBtn.innerHTML = '<i class="fas fa-check-circle"></i> Evaluado';
                        }
                    }
                    updateCompletedCount();

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al guardar',
                        text: data.message,
                    });
                }
            } catch (error) {
                console.error('Error al enviar el formulario:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'No se pudo conectar con el servidor para guardar la evaluación.'
                });
            }
        }


        async function marcarComoEvaluado(buttonElement) {
            const form = buttonElement.closest('form');
            
            const requiredInputs = form.querySelectorAll('input[required], select[required], textarea[required]');
            let allFilled = true;
            requiredInputs.forEach(input => {
                if (input.type === 'checkbox') {
                    return; 
                }
                if (!input.value.trim()) {
                    allFilled = false;
                    input.style.borderColor = 'var(--accent-red)';
                } else {
                    input.style.borderColor = 'var(--border-color)';
                }
            });

            const estudianteId = form.querySelector('input[name="estudiante_id"]').value;
            const generoF = form.querySelector(`#genero_f_${estudianteId}`);
            const generoM = form.querySelector(`#genero_m_${estudianteId}`);
            if (!generoF.checked && !generoM.checked) {
                allFilled = false;
                generoF.closest('.checkbox-group').style.border = '1px solid var(--accent-red)';
                generoM.closest('.checkbox-group').style.border = '1px solid var(--accent-red)';
            } else {
                generoF.closest('.checkbox-group').style.border = 'none';
                generoM.closest('.checkbox-group').style.border = 'none';
            }


            if (!allFilled) {
                Swal.fire({
                    icon: 'error',
                    title: 'Faltan datos',
                    text: 'Faltan datos obligatorios para marcar y guardar la evaluación. Por favor, revise los campos resaltados.',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            Swal.fire({
                title: '¿Marcar como Evaluado?',
                text: 'Esta acción registrará la evaluación del alumno y guardará todos los datos rellenados.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, marcar',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const formData = new FormData(form); 
                        
                        // Asegurarse de que los valores de los checkboxes se incluyan correctamente
                        form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                            if (!checkbox.checked) {
                                formData.set(checkbox.name, ''); // Send empty string for unchecked checkboxes
                            }
                        });

                        // Asegurarse de que el campo de fecha de reevaluación para PDF esté presente
                        const fechaReevaluacionPdfInput = form.querySelector('input[name="fecha_reevaluacion_pdf"]');
                        if (fechaReevaluacionPdfInput) {
                            formData.set('fecha_reevaluacion_pdf', fechaReevaluacionPdfInput.value);
                        }

                        // Debugging: Log FormData content
                        console.log('FormData content before sending (marcarComoEvaluado):');
                        for (let pair of formData.entries()) {
                            console.log(pair[0]+ ': ' + pair[1]); 
                        }

                        const response = await fetch('/marcar_evaluado', {
                            method: 'POST',
                            body: formData 
                        });
                        const data = await response.json();

                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Evaluado y Guardado!',
                                text: data.message,
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.reload(); 
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message
                            });
                        }
                    } catch (error) {
                        console.error('Error al marcar como evaluado:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de Conexión',
                            text: 'No se pudo conectar con el servidor para marcar la evaluación.'
                        });
                    }
                }
            });
        }

        // Función para generar un PDF individual
        async function generarPDF(form) {
            const formData = new FormData(form);

            // Manually set checkbox values if they are unchecked
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked) {
                    formData.set(checkbox.name, ''); 
                }
            });
            // Ensure fecha_reevaluacion_pdf is set from the hidden input
            const fechaReevaluacionPdfInput = form.querySelector('input[name="fecha_reevaluacion_pdf"]');
            if (fechaReevaluacionPdfInput) {
                formData.set('fecha_reevaluacion_pdf', fechaReevaluacionPdfInput.value);
            }

            Swal.fire({
                title: 'Generando PDF...',
                text: 'Por favor, espera.',
                didOpen: () => {
                    Swal.showLoading();
                },
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            try {
                const response = await fetch('/generar_pdf', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // Obtener el nombre del archivo de la cabecera Content-Disposition si está disponible
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'formulario_evaluado.pdf';
                    if (contentDisposition && contentDisposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(contentDisposition);
                        if (matches != null && matches[1]) {
                            filename = decodeURIComponent(matches[1].replace(/['"]/g, ''));
                        }
                    }
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    Swal.fire({
                        icon: 'success',
                        title: 'PDF Generado',
                        text: 'El PDF se ha descargado correctamente.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    const errorText = await response.text();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al generar PDF',
                        text: `No se pudo generar el PDF. ${errorText}`,
                    });
                }
            } catch (error) {
                console.error('Error al generar PDF:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'No se pudo conectar con el servidor para generar el PDF.'
                });
            }
        }

        // Función para generar y abrir múltiples PDFs en una nueva ventana para imprimir
        async function generarEImprimirPDFsVisibles(nominaId, establecimientoNombre) {
            const visibleStudentIds = [];
            document.querySelectorAll('details.estudiante:not([style*="display: none"])').forEach(detail => {
                visibleStudentIds.push(detail.getAttribute('data-estudiante-id'));
            });

            if (visibleStudentIds.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'No hay formularios visibles',
                    text: 'Ajusta los filtros para ver formularios y luego intenta imprimir.',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            Swal.fire({
                title: 'Generando PDF combinado...',
                html: 'Esto puede tardar un momento si hay muchos formularios. <br><br> <i class="fas fa-spinner fa-spin"></i>',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/generar_pdfs_visibles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        nomina_id: nominaId,
                        student_ids: visibleStudentIds 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al generar el PDF combinado.');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                const printWindow = window.open(url, '_blank');
                printWindow.onload = () => {
                    printWindow.print();
                    printWindow.onafterprint = () => {
                        window.URL.revokeObjectURL(url); // Liberar el objeto URL
                        printWindow.close(); // Cerrar la ventana después de la impresión
                    };
                };

                Swal.fire({
                    icon: 'success',
                    title: 'PDFs Abiertos para Imprimir',
                    text: 'Se ha abierto una nueva ventana con los formularios listos para imprimir.',
                    showConfirmButton: false,
                    timer: 3000
                });

            } catch (error) {
                console.error('Error al generar e imprimir PDFs visibles:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de impresión',
                    text: error.message || 'No se pudo generar o abrir los PDFs para imprimir. Intente de nuevo más tarde.',
                });
            } finally {
                Swal.close();
            }
        }


        function enviarADrive(form) {
            Swal.fire({
                title: 'Enviando a Google Drive...',
                html: 'Esto puede tardar un momento. <br><br> <i class="fas fa-spinner fa-spin"></i>',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const formData = new FormData(form);

            // Asegurarse de que los valores de los checkboxes se incluyan correctamente
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked) {
                    formData.set(checkbox.name, ''); 
                }
            });

            // Asegurarse de que el campo de fecha de reevaluación para PDF esté presente
            const fechaReevaluacionPdfInput = form.querySelector('input[name="fecha_reevaluacion_pdf"]');
            if (fechaReevaluacionPdfInput) {
                formData.set('fecha_reevaluacion_pdf', fechaReevaluacionPdfInput.value);
            }

            fetch('/enviar_formulario_a_drive', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Enviado a Drive!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al enviar a Drive',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Error al enviar a Drive:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'No se pudo conectar con el servidor para enviar a Google Drive.'
                });
            });
        }

        function insertarFirma() {
            Swal.fire({
                icon: 'info',
                title: 'Próximamente',
                text: 'Se insertará la firma según la doctora que corresponda.'
            });
        }

        // Función para aplicar filtros de búsqueda y estado de evaluación
        function aplicarFiltros() {
            const estudiantes = document.querySelectorAll('details.estudiante');
            const searchTerm = document.getElementById('buscador').value.toLowerCase().trim();
            const evaluationFilter = document.querySelector('input[name="evaluation_filter"]:checked').value;

            estudiantes.forEach(detail => {
                const nombre = detail.getAttribute('data-nombre');
                const isEvaluated = detail.getAttribute('data-evaluated-status') === 'true';

                const matchesSearch = nombre.includes(searchTerm);
                let matchesFilter = false;

                if (evaluationFilter === 'all') {
                    matchesFilter = true;
                } else if (evaluationFilter === 'evaluated') {
                    matchesFilter = isEvaluated;
                } else if (evaluationFilter === 'not_evaluated') {
                    matchesFilter = !isEvaluated;
                }

                if (matchesSearch && matchesFilter) {
                    detail.style.display = ''; // Mostrar
                } else {
                    detail.style.display = 'none'; // Ocultar
                }
            });
        }

        // Función para imprimir todos los formularios visibles (HTML)
        function imprimirTodosLosFormularios() {
            Swal.fire({
                title: 'Preparando impresión de HTML...',
                text: 'Esto puede tardar un momento.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            setTimeout(() => { 
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Imprimir Formularios</title>');
                printWindow.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">');
                printWindow.document.write('<style>');
                printWindow.document.write(`
                    body { font-family: 'Segoe UI', sans-serif; margin: 20px; color: #333; }
                    .print-form-container { margin-bottom: 25px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; page-break-inside: avoid; }
                    .print-form-container h3 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 15px; }
                    .print-form-container p { margin: 8px 0; }
                    .print-form-container p strong { display: inline-block; width: 150px; color: #1a73e8; }
                    /* Ocultar elementos de UI para impresión */
                    .formulario .button-group, .formulario label, .formulario input:not([readonly]), .formulario textarea, .formulario select, .preview button, .preview-img, .badge, .checkbox-item { display: none !important; }
                    .formulario input[readonly] { border: none; background-color: transparent; }

                    /* Asegurar que los inputs y textareas muestren su valor como texto normal */
                    input, textarea, select {
                        border: none !important;
                        box-shadow: none !important;
                        background-color: transparent !important;
                        -webkit-print-color-adjust: exact; 
                        color-adjust: exact;
                        padding: 0 !important;
                        margin: 0 !important;
                    }
                    textarea {
                        resize: none !important;
                    }
                    .checkbox-preview-group p {
                        margin-left: 20px; /* Indentar los detalles del checkbox */
                    }
                `);
                printWindow.document.write('</style></head><body>');

                const visibleForms = document.querySelectorAll('details.estudiante:not([style*="display: none"])');
                if (visibleForms.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No hay formularios para imprimir',
                        text: 'Ajusta el filtro de búsqueda si es necesario.',
                        showConfirmButton: true
                    });
                    printWindow.close();
                    return;
                }

                visibleForms.forEach(detail => {
                    const studentName = detail.querySelector('summary span').textContent;
                    const previewContent = detail.querySelector('.preview').cloneNode(true);
                    
                    // Ocultar la imagen de vista previa si existe
                    const previewImg = previewContent.querySelector('.preview-img');
                    if (previewImg) {
                        previewImg.style.display = 'none';
                    }
                    
                    // Ocultar el botón de imprimir vista previa
                    const printPreviewButton = previewContent.querySelector('button');
                    if (printPreviewButton) {
                        printPreviewButton.style.display = 'none';
                    }

                    printWindow.document.write(`<div class="print-form-container">`);
                    printWindow.document.write(`<h3>Formulario de ${studentName}</h3>`);
                    printWindow.document.write(previewContent.innerHTML); 
                    printWindow.document.write(`</div>`);
                });

                printWindow.document.write('</body></html>');
                printWindow.document.close(); 
                printWindow.focus(); 
                printWindow.print(); 
                printWindow.onafterprint = function() {
                    printWindow.close(); 
                    Swal.close(); 
                };
            }, 500); 
        }

        // Función para descargar Excel de formularios completados
        function descargarExcelCompletados(nominaId, establecimientoNombre) {
            Swal.fire({
                title: 'Preparando descarga...',
                text: 'Generando archivo Excel de formularios evaluados. Por favor, espere.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`/descargar_excel_evaluados/${nominaId}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'Error al descargar el Excel.');
                        });
                    }
                    return response.blob(); 
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `Evaluaciones_${establecimientoNombre.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    Swal.fire({
                        icon: 'success',
                        title: 'Descarga completa',
                        text: 'El archivo Excel se ha descargado correctamente.',
                        showConfirmButton: false,
                        timer: 2000
                    });
                })
                .catch(error => {
                    console.error('Error al descargar Excel:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de descarga',
                        text: error.message || 'No se pudo descargar el archivo Excel. Intente de nuevo más tarde.',
                    });
                });
        }

        // Función para actualizar el contador de formularios completados en la interfaz
        function updateCompletedCount() {
            const completedCount = document.querySelectorAll('details.estudiante[data-evaluated-status="true"]').length;
            document.getElementById('completed-forms-count').textContent = completedCount;
        }

        // Llamar a updateCompletedCount cuando la página se carga para asegurar que el contador sea preciso
        document.addEventListener('DOMContentLoaded', updateCompletedCount);
    </script>
</body>
</html>
