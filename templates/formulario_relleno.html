<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rellenar Formulario - CardioHome</title>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables CSS para una gestión de colores y espaciado más fácil */
        :root {
            --primary-dark: hsl(210, 29%, 18%); /* Azul pizarra muy oscuro */
            --primary-medium: hsl(210, 15%, 28%); /* Azul pizarra medio */
            --primary-light: hsl(210, 16%, 92%); /* Gris azulado muy claro */
            --background-body: linear-gradient(135deg, hsl(200, 20%, 98%) 0%, hsl(210, 15%, 96%) 100%); /* Degradado suave para el cuerpo */
            --accent-green: hsl(140, 65%, 45%); /* Verde vibrante */
            --accent-red: hsl(0, 75%, 58%); /* Rojo intenso */
            --accent-blue: hsl(200, 70%, 55%); /* Azul cielo brillante */
            --google-drive-blue: #4285F4; /* Azul de Google Drive */
            --signature-purple: #8B5CF6; /* Púrpura para firma */
            --text-dark: hsl(210, 10%, 15%);
            --text-light: hsl(0, 0%, 99%);
            --border-color: hsl(210, 10%, 82%); /* Borde más definido */
            --shadow-subtle: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --shadow-strong: rgba(0, 0, 0, 0.25);
            --border-radius-base: 14px;
            --padding-base: 28px;
            --gap-base: 30px;
        }

        /* Estilos generales del cuerpo */
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--background-body); /* Fondo degradado */
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 20px; /* Reducido para mejor visualización en pantallas pequeñas */
            margin: 0; /* Asegura que no haya márgenes no deseados */
        }

        /* Contenedor principal para centrar el contenido */
        .main-content-wrapper {
            max-width: 1200px; /* Ancho máximo para el contenido principal */
            margin: 20px auto; /* Centrar y añadir margen superior/inferior */
            padding: 0 20px; /* Espaciado interno */
            flex-grow: 1; /* Permite que el wrapper crezca y ocupe espacio disponible */
        }

        header {
            background-color: #f0f4f8; /* Fondo del header para consistencia */
            padding: 20px 0;
            text-align: center;
            position: relative; /* Para posicionar los botones */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); /* Sombra suave */
        }

        header img {
            max-width: 150px; /* Tamaño más consistente */
            margin-bottom: 10px;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Efecto al pasar el mouse */
        }

        header img:hover {
            transform: scale(1.05); /* Ligeramente más grande */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Sombra al pasar el mouse */
        }

        header h1 {
            font-size: 1.8rem; /* Tamaño de fuente más grande */
            color: #333; /* Color de texto más oscuro */
            margin-top: 5px;
            font-weight: 700;
        }

        /* Eliminado: .breadcrumb */

        /* Estilos para los botones del header */
        .header-btn {
            position: absolute;
            top: 20px;
            padding: 10px 18px;
            border-radius: 25px; /* Más redondeado */
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .back-to-dashboard-btn {
            left: 20px;
            background-color: #6c757d; /* Gris */
            color: #fff;
        }
        .back-to-dashboard-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        .logout-btn {
            right: 20px;
            background-color: #dc3545; /* Rojo */
            color: #fff;
        }
        .logout-btn:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        /* Contador de evaluaciones */
        .evaluation-counter {
            background-color: #e6f7ff; /* Azul claro */
            border: 1px solid #99d6ff;
            border-radius: 10px;
            padding: 15px 25px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a73e8; /* Azul del tema */
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            flex-wrap: wrap; /* Para responsividad */
        }
        .evaluation-counter i {
            color: #1a73e8;
            font-size: 1.3em;
        }
        .evaluation-counter strong {
            color: #34a853; /* Verde de éxito */
            font-size: 1.1em;
        }
        .evaluation-counter button {
            background-color: #1a73e8;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 15px;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .evaluation-counter button:hover {
            background-color: #155ab6;
            transform: translateY(-2px);
        }

        #buscador {
            width: 100%;
            max-width: 500px; /* Un poco más ancho para búsquedas */
            display: block;
            margin: 0 auto 30px;
            padding: 12px 15px;
            border: 1px solid #b0c2d4; /* Borde más suave */
            border-radius: 8px;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        #buscador:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.3);
            outline: none;
        }

        details {
            margin-bottom: 25px; /* Más espacio entre estudiantes */
            border-radius: 12px;
            overflow: hidden; /* Asegura bordes redondeados */
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* Sombra para el detalle */
            transition: all 0.3s ease;
        }
        details[open] {
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* Sombra más fuerte al abrir */
        }

        summary {
            background: #1a73e8; /* azul uniforme para todos */
            color: #fff;
            padding: 18px 25px; /* Más padding */
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex; /* Para alinear icono y texto */
            align-items: center;
            justify-content: space-between;
            font-size: 1.15rem; /* Texto de sumario más grande */
            transition: background 0.3s ease;
        }
        summary:hover {
            background: #155ab6;
        }
        summary::marker { /* Ocultar el marcador predeterminado */
            display: none;
            content: "";
        }
        summary::-webkit-details-marker { /* Para Webkit */
            display: none;
        }
        summary:focus {
            outline: none; /* Eliminar el contorno de enfoque */
        }
        details[open] summary {
            border-bottom: 1px solid rgba(255,255,255,0.2); /* Separador cuando abierto */
        }
        summary .chevron-icon {
            transition: transform 0.3s ease;
        }
        details[open] summary .chevron-icon {
            transform: rotate(90deg);
        }

        .container {
            display: flex;
            gap: 30px; /* Menos espacio para mejor uso del ancho */
            flex-wrap: wrap;
            padding: 25px; /* Padding interno del contenedor */
            background-color: #ffffff;
            border-top: none; /* Eliminar el borde superior duplicado */
            border-radius: 0 0 12px 12px; /* Solo esquinas inferiores redondeadas */
        }

        .formulario {
            flex: 1 1 500px; /* Base más flexible */
            background: #ffffff;
            border-left: 6px solid #1a73e8;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            padding: 30px;
            position: relative;
        }

        .badge {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #34a853;
            color: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .badge.show {
            opacity: 1;
            transform: translateY(0);
        }

        .preview {
            flex: 1 1 350px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            border-left: 6px solid #1a73e8;
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }

        .preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .preview h3 {
            margin-top: 0;
            font-size: 1.4rem;
            color: #1a73e8;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .preview p {
            margin: 12px 0;
            font-size: 1rem;
            color: #333;
        }

        .preview p strong {
            display: inline-block;
            width: 180px;
            color: #1a73e8;
        }

        .preview span {
            font-weight: 500;
            color: #555;
        }

        .preview-img {
            display: block;
            width: 100%;
            height: auto; /* Asegura que la imagen se adapte */
            margin-top: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            margin-top: 5px;
            border: 1px solid #b0c2d4; /* Borde más suave */
            border-radius: 6px;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.3);
            outline: none;
        }
        input[type="date"] {
            -webkit-appearance: none; /* Quitar estilo nativo en Webkit */
            -moz-appearance: none; /* Quitar estilo nativo en Mozilla */
            appearance: none;
            background-color: #fff;
            padding-right: 30px; /* Espacio para el icono del calendario */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="%231a73e8"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.11 0-1.99.89-1.99 2L2 21c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 18H4V8h16v13z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 20px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Más espacio entre botones */
            margin-top: 25px; /* Más margen superior */
            justify-content: center; /* Centrar botones */
        }

        button {
            flex: 1 1 auto; /* Permitir que los botones se adapten al contenido y se envuelvan */
            background: #1a73e8;
            color: #fff;
            border: none;
            padding: 14px 20px; /* Más padding */
            border-radius: 8px; /* Ligeramente más redondeado */
            cursor: pointer;
            font-weight: bold;
            font-size: 1.05rem; /* Un poco más grande */
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        button:hover {
            background: #155ab6;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        button.secondary {
            background: #34a853; /* Verde para acciones secundarias */
        }

        button.secondary:hover {
            background: #2c8c46;
        }
        
        button.signature-button {
            background: #8B5CF6; /* Púrpura para firma */
        }
        button.signature-button:hover {
            background: #7A3FEE;
        }

        p.info {
            margin: 5px 0;
            font-weight: 500;
            color: #555;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsividad */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .main-content-wrapper {
                margin: 15px auto;
                padding: 0 10px;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .header-btn {
                position: static; /* Quitar posicionamiento absoluto */
                margin-bottom: 10px; /* Espacio entre botones */
                width: calc(100% - 40px); /* Ocupar casi todo el ancho */
                margin-left: auto;
                margin-right: auto;
                display: block;
                text-align: center;
            }
            .back-to-dashboard-btn { order: 1; }
            .logout-btn { order: 2; }
            header {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #buscador {
                max-width: 100%;
            }
            .container {
                flex-direction: column;
                gap: 20px;
                padding: 15px;
            }
            .formulario, .preview {
                flex: 1 1 100%; /* Ocupar todo el ancho */
                padding: 20px;
            }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 100%;
                font-size: 1rem;
                padding: 12px 15px;
            }
            .preview p strong {
                width: 120px; /* Reducir el ancho en móvil */
            }
        }

    </style>
</head>
<body>
    <header>
        <a href="{{ url_for('dashboard') }}" class="header-btn back-to-dashboard-btn">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
        {# CORRECTED LOGO PATH AND EFFECT HERE #}
        <img src="{{ url_for('static', filename='logo.png') }}" alt="CardioHome Logo">
        {# REPLACED DOCTOR'S NAME WITH ESTABLISHMENT NAME #}
        <h1>{{ session['establecimiento'] }} — Relleno de Formularios</h1>
        <button class="header-btn logout-btn" onclick="cerrarSesion()">
            <i class="fas fa-sign-out-alt"></i> Cerrar sesión
        </button>
    </header>

    <div class="main-content-wrapper">
        {# REMOVED BREADCRUMB NAVIGATION #}
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        
        {# Contador de evaluaciones #}
        <div class="evaluation-counter">
            <i class="fas fa-clipboard-check"></i>
            <span>Evaluaciones completadas para esta nómina: <strong>{{ total_forms_completed_for_nomina }}</strong></span>
            <button onclick="window.location.reload();">Actualizar Conteo</button>
        </div>

        <input type="text" id="buscador" placeholder="Buscar estudiante por nombre...">

        {% if estudiantes %}
            {% for est in estudiantes %}
            <details class="estudiante" data-nombre="{{ est.nombre | lower }}">
                <summary>
                    <span>{{ est.nombre }}</span>
                    <i class="fas fa-chevron-right chevron-icon"></i>
                </summary>
                <div class="container">
                    <div class="formulario">
                        <span class="badge">Guardado</span>
                        <form action="{{ url_for('generar_pdf') }}" method="POST" oninput="updatePreview(this)">
                            <!-- Campos ocultos para pasar el ID del estudiante y la nómina al backend -->
                            <input type="hidden" name="estudiante_id" value="{{ est.id }}">
                            <input type="hidden" name="nomina_id" value="{{ session['current_nomina_id'] }}">

                            <label>Nombre:</label>
                            <input type="text" name="nombre" value="{{ est.nombre }}" required readonly>

                            <label>RUT:</label>
                            <input type="text" name="rut" value="{{ est.rut }}" required readonly>

                            <!-- Campos ocultos que ya se pre-rellenan -->
                            <input type="hidden" name="fecha_nacimiento" value="{{ est.fecha_nacimiento_formato }}"> {# Usar el formato ya procesado #}
                            <input type="hidden" name="edad" value="{{ est.edad }}">
                            <input type="hidden" name="nacionalidad" value="{{ est.nacionalidad }}">
                            
                            {# SEXO: Changed from hidden input to select for editability, pre-selected with est.sexo #}
                            <label>Sexo:</label>
                            <select name="sexo" required onchange="updatePreview(this.form)">
                                <option value="M" {% if est.sexo == 'M' %}selected{% endif %}>Masculino</option>
                                <option value="F" {% if est.sexo == 'F' %}selected{% endif %}>Femenino</option>
                            </select>

                            <p class="info"><strong>Fecha de nacimiento:</strong> {{ est.fecha_nacimiento_formato }} ({{ est.edad }})</p>
                            <p class="info"><strong>Nacionalidad:</strong> {{ est.nacionalidad }}</p>
                            {# Sexo display below, now reflecting the selected value, not just the hidden one #}
                            <p class="info"><strong>Sexo:</strong> <span class="prev-sexo-info">{{ 'Masculino' if est.sexo == 'M' else 'Femenino' }}</span></p>


                            <label>Estado general del alumno:</label>
                            <textarea name="estado" rows="3" placeholder="Observaciones del estado general..." required>{{ est.estado_general if est.estado_general is not none else '' }}</textarea>

                            <label>Diagnóstico:</label>
                            <select name="diagnostico" required onchange="updatePreview(this.form)">
                                <option value="">Seleccionar diagnóstico</option>
                                <option value="Trastorno espectro autista" {% if est.diagnostico == 'Trastorno espectro autista' %}selected{% endif %}>Trastorno espectro autista</option>
                                <option value="GARC" {% if est.diagnostico == 'GARC' %}selected{% endif %}>GARC</option>
                                <option value="Trastorno por deficit de atención" {% if est.diagnostico == 'Trastorno por deficit de atención' %}selected{% endif %}>Trastorno por deficit de atención</option>
                                <option value="Trastorno por deficit de atención e hiperactividad" {% if est.diagnostico == 'Trastorno por deficit de atención e hiperactividad' %}selected{% endif %}>Trastorno por deficit de atención e hiperactividad</option>
                                <option value="FIL" {% if est.diagnostico == 'FIL' %}selected{% endif %}>FIL</option>
                                <option value="DIL" {% if est.diagnostico == 'DIL' %}selected{% endif %}>DIL</option>
                                <option value="Sindrome de Down" {% if est.diagnostico == 'Sindrome de Down' %}selected{% endif %}>Sindrome de Down</option>
                            </select>

                            <label>Plazo de reevaluación:</label>
                            <select name="plazo" onchange="setFechaReevaluacion(this)">
                                <option value="">Seleccionar plazo</option>
                                <option value="1">1 año</option>
                                <option value="2">2 años</option>
                                <option value="3">3 años</option>
                                <option value="4">4 años</option>
                                <option value="5">5 años</option>
                            </select>

                            <label>Fecha de reevaluación:</label>
                            <input type="date" name="fecha_reevaluacion" required>

                            <label>Derivaciones:</label>
                            <textarea name="derivaciones" rows="2" placeholder="Detalles de derivaciones...">{{ est.derivaciones if est.derivaciones is not none else '' }}</textarea>

                            <div class="button-group">
                                <button type="submit">
                                    <i class="fas fa-file-pdf"></i> Guardar y Generar PDF
                                </button>
                                <button type="button" class="secondary" onclick="enviarADrive()">
                                    <i class="fab fa-google-drive"></i> Enviar a Drive
                                </button>
                                <button type="button" class="secondary signature-button" onclick="insertarFirma()">
                                    <i class="fas fa-signature"></i> Insertar Firma
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="preview">
                        <h3>Vista Previa</h3>
                        <p><strong>Nombre:</strong> <span class="prev-nombre">{{ est.nombre }}</span></p>
                        <p><strong>RUT:</strong> <span class="prev-rut">{{ est.rut }}</span></p>
                        <p><strong>Estado:</strong> <span class="prev-estado">-</span></p>
                        <p><strong>Diagnóstico:</strong> <span class="prev-diagnostico">-</span></p>
                        <p><strong>Fecha Reevaluación:</strong> <span class="prev-reevaluacion">-</span></p>
                        <p><strong>Derivaciones:</strong> <span class="prev-derivaciones">-</span></p>
                        {# Updated prev-sexo span to reflect the <select> value, not the hidden input #}
                        <p><strong>Sexo:</strong> <span class="prev-sexo"></span></p> 


                        <img src="/static/formulario_muestra.png" alt="Ejemplo Formulario" class="preview-img" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=Imagen+No+Disponible';" />

                        <button onclick="window.print()" style="margin-top: 20px; width: 100%;">
                            <i class="fas fa-print"></i> Imprimir Vista Previa
                        </button>
                    </div>
                </div>
            </details>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #888; font-size: 1.1rem; margin-top: 50px;">No hay estudiantes en esta nómina o ha ocurrido un error al cargarlos.</p>
        {% endif %}
    </div>

    <footer>
        © 2025 CardioHome · Todos los derechos reservados.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const buscador = document.getElementById('buscador');
            if (buscador) {
                buscador.addEventListener('input', function() {
                    const estudiantes = document.querySelectorAll('.estudiante');
                    const searchTerm = this.value.toLowerCase().trim();
                    estudiantes.forEach(detail => {
                        const nombre = detail.getAttribute('data-nombre');
                        if (nombre.includes(searchTerm)) {
                            detail.style.display = '';
                        } else {
                            detail.style.display = 'none';
                        }
                    });
                });
            }

            // Inicializar las previsualizaciones y el select de reevaluación al cargar
            document.querySelectorAll('.formulario form').forEach(form => {
                updatePreview(form); // Actualiza la vista previa con los valores iniciales
                const selectPlazo = form.querySelector('select[name="plazo"]');
                const fechaReevaluacionInput = form.querySelector('input[name="fecha_reevaluacion"]');
                
                // Si la fecha de reevaluación ya viene pre-cargada del servidor (ej. de DB), la mostramos.
                // De lo contrario, intentamos calcularla si hay un plazo ya seleccionado.
                if (fechaReevaluacionInput && fechaReevaluacionInput.value) {
                    // La fecha ya está en el input, no hacemos nada más con el plazo.
                } else if (selectPlazo && selectPlazo.value) {
                    setFechaReevaluacion(selectPlazo);
                }
            });
        });

        function cerrarSesion() {
            window.location.href = "/logout";
        }

        function setFechaReevaluacion(select) {
            const anos = parseInt(select.value);
            const form = select.closest('form');
            const fechaReevaluacionInput = form.querySelector('input[name="fecha_reevaluacion"]');
            
            if (!isNaN(anos) && anos > 0) {
                const today = new Date();
                // Usar el día actual para evitar problemas con fines de mes (ej. 31 de Enero + 1 mes = 2 de Marzo)
                const futureDate = new Date(today.getFullYear() + anos, today.getMonth(), today.getDate()); 

                const year = futureDate.getFullYear();
                // Los meses en JavaScript son de 0-11, por eso +1
                const month = String(futureDate.getMonth() + 1).padStart(2, '0');
                const day = String(futureDate.getDate()).padStart(2, '0');

                fechaReevaluacionInput.value = `${year}-${month}-${day}`; // Formato YYYY-MM-DD para input type="date"
            } else {
                fechaReevaluacionInput.value = ''; // Limpiar si no es una selección válida
            }
            updatePreview(form); // Actualizar vista previa inmediatamente
        }

        function updatePreview(form) {
            const container = form.closest('.container');
            if (!container) return; // Salir si no encuentra el contenedor

            // Actualizar campos de vista previa
            container.querySelector('.prev-nombre').textContent = form.nombre.value;
            container.querySelector('.prev-rut').textContent = form.rut.value;
            container.querySelector('.prev-estado').textContent = form.estado ? form.estado.value : '-';
            container.querySelector('.prev-diagnostico').textContent = form.diagnostico ? form.diagnostico.value : '-';
            container.querySelector('.prev-derivaciones').textContent = form.derivaciones ? form.derivaciones.value : '-';
            
            // La fecha de reevaluación la tomamos del input type="date"
            const fechaReevaluacionInput = form.querySelector('input[name="fecha_reevaluacion"]');
            if (fechaReevaluacionInput && fechaReevaluacionInput.value) {
                // Si el formato es YYYY-MM-DD, lo convertimos a DD/MM/YYYY para mostrar
                const [year, month, day] = fechaReevaluacionInput.value.split('-');
                container.querySelector('.prev-reevaluacion').textContent = `${day}/${month}/${year}`;
            } else {
                container.querySelector('.prev-reevaluacion').textContent = '-';
            }

            // Actualizar el campo de sexo en la vista previa (ahora del select)
            const sexoSelect = form.querySelector('select[name="sexo"]');
            if (sexoSelect) {
                container.querySelector('.prev-sexo').textContent = sexoSelect.value === 'M' ? 'Masculino' : 'Femenino';
            } else {
                container.querySelector('.prev-sexo').textContent = '-';
            }


            // Lógica del badge "Guardado"
            const badge = form.closest('.formulario').querySelector('.badge');
            if (badge) {
                badge.classList.add('show');
                badge.textContent = "Modificando..."; // Cambiado para indicar que se está editando
                clearTimeout(badge.timeout);
                badge.timeout = setTimeout(() => {
                    badge.textContent = "Guardado";
                }, 800);
            }
        }

        function mostrarExito() {
            setTimeout(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'PDF generado correctamente',
                    showConfirmButton: false,
                    timer: 1500
                });
            }, 100); // Pequeño delay para que la acción del formulario inicie primero
        }

        function enviarADrive() {
            Swal.fire({
                icon: 'info',
                title: 'Próximamente',
                text: 'Aquí se conectará con Google Drive.'
            });
        }

        function insertarFirma() {
            Swal.fire({
                icon: 'info',
                title: 'Próximamente',
                text: 'Se insertará la firma según la doctora que corresponda.'
            });
        }
    </script>
</body>
</html>
