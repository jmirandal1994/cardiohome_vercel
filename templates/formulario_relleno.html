<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rellenar Formulario - CardioHome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Variables CSS personalizadas */
        :root {
            --primary-dark: hsl(210, 29%, 18%); /* Azul pizarra muy oscuro */
            --primary-medium: hsl(210, 15%, 28%); /* Azul pizarra medio */
            --primary-light: hsl(210, 16%, 92%); /* Gris azulado muy claro */
            --background-body: linear-gradient(135deg, hsl(200, 20%, 98%) 0%, hsl(210, 15%, 96%) 100%); /* Degradado suave para el cuerpo */
            --accent-green: hsl(140, 65%, 45%); /* Verde vibrante */
            --accent-red: hsl(0, 75%, 58%); /* Rojo intenso */
            --accent-blue: hsl(200, 70%, 55%); /* Azul cielo brillante */
            --google-drive-blue: #4285F4; /* Azul de Google Drive */
            --signature-purple: #8B5CF6; /* Púrpura para firma */
            --text-dark: hsl(210, 10%, 15%);
            --text-light: hsl(0, 0%, 99%);
            --border-color: hsl(210, 10%, 82%); /* Borde más definido */
            --shadow-subtle: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --shadow-strong: rgba(0, 0, 0, 0.25);
            --border-radius-base: 14px;
            --padding-base: 28px;
            --gap-base: 30px;
        }

        /* Fuentes de Google Fonts para un aspecto más profesional */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@400;500;600;700;800&display=swap');

        /* Font Awesome para íconos */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');

        /* Estilos generales del cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--background-body);
            color: var(--text-dark);
            line-height: 1.7; /* Mejor legibilidad */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Estilos del header */
        header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-medium) 100%);
            color: var(--text-light);
            padding: 2rem 0; /* Mayor padding */
            text-align: center;
            box-shadow: 0 10px 30px var(--shadow-strong); /* Sombra más pronunciada */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        header img {
            width: 140px; /* Logo aún más grande en el encabezado */
            height: auto;
            filter: brightness(0) invert(1) drop-shadow(0 5px 15px rgba(0,0,0,0.4)); /* Sombra para el logo */
            margin-bottom: 10px;
            transition: transform 0.4s ease-out;
        }
        header img:hover {
            transform: scale(1.1); /* Efecto de zoom más dinámico */
        }

        header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 36px; /* Título aún más grande */
            margin-top: 0;
            margin-bottom: 0;
            font-weight: 800;
            letter-spacing: 1.2px; /* Mayor espaciado entre letras */
            text-shadow: 3px 4px 6px rgba(0,0,0,0.5); /* Sombra de texto más profunda */
        }

        .back-button, .logout-btn {
            background: linear-gradient(45deg, var(--accent-blue) 0%, hsl(200, 60%, 45%) 100%); /* Degradado para botones */
            color: var(--text-light);
            border: none;
            padding: 14px 25px; /* Mayor padding */
            border-radius: 18px; /* Más redondeado */
            cursor: pointer;
            font-weight: 600;
            font-size: 16px; /* Tamaño de fuente ligeramente más grande */
            transition: all 0.3s ease-out; /* Transición global para todos los efectos */
            position: absolute;
            top: 25px; /* Ajuste de posición */
            display: flex;
            align-items: center;
            gap: 12px; /* Mayor espacio entre icono y texto */
            box-shadow: 0 5px 15px var(--shadow-medium); /* Sombra más notable */
            text-decoration: none;
        }

        .back-button {
            left: 30px; /* Ajuste de posición */
        }
        .logout-btn {
            right: 30px; /* Ajuste de posición */
            background: linear-gradient(45deg, var(--accent-red) 0%, hsl(0, 65%, 50%) 100%); /* Degradado para cerrar sesión */
        }

        .back-button:hover, .logout-btn:hover {
            transform: translateY(-5px) scale(1.03); /* Efecto 3D de elevación y ligero zoom */
            box-shadow: 0 10px 25px var(--shadow-strong); /* Sombra más grande en hover */
        }

        .container {
            padding: var(--gap-base) 50px; /* Mayor padding horizontal */
            max-width: 1500px; /* Mayor ancho máximo */
            margin: var(--gap-base) auto;
            flex-grow: 1;
        }

        .card {
            background: linear-gradient(160deg, #ffffff 0%, #f7fcff 100%); /* Degradado suave para las tarjetas */
            padding: var(--padding-base);
            border-radius: 20px; /* Más redondeado */
            box-shadow: 0 12px 35px rgba(0,0,0,0.18), 0 4px 8px rgba(0,0,0,0.1); /* Doble sombra para profundidad */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.4s ease; /* Transición más suave */
            border: 1px solid hsl(210, 10%, 85%); /* Borde sutil y más claro */
            margin-bottom: var(--gap-base);
            position: relative;
            overflow: hidden; /* Para contener efectos internos */
        }
        .card:hover {
            transform: translateY(-10px); /* Elevación más pronunciada */
            box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 8px 15px rgba(0,0,0,0.18); /* Sombra en hover */
        }
        .card::before { /* Efecto de onda de fondo */
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(200,230,255,0.3) 0%, transparent 70%);
            border-radius: 50%;
            transition: transform 0.5s ease-out;
            z-index: 0;
            opacity: 0.8;
        }
        .card:hover::before {
            transform: scale(1.5);
            opacity: 0;
        }


        .card h3 {
            font-family: 'Montserrat', sans-serif;
            margin-top: 0;
            margin-bottom: 30px; /* Mayor espacio debajo del título */
            color: var(--primary-dark);
            font-size: 26px; /* Título de tarjeta más grande */
            font-weight: 800; /* Más peso para el título */
            border-bottom: 4px solid var(--accent-blue); /* Borde inferior más grueso y de color principal */
            padding-bottom: 20px; /* Mayor padding debajo del borde */
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1; /* Asegurar que esté por encima del pseudo-elemento */
        }
        .card h3 i {
            color: var(--accent-blue);
            font-size: 1.4em; /* Icono más grande */
        }
        .card h3::after { /* Efecto decorativo bajo el título */
            content: '';
            position: absolute;
            left: 0;
            bottom: -4px; /* Alineado con el borde */
            width: 70px; /* Ancho del subrayado de acento */
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green) 0%, transparent 100%); /* Degradado para el subrayado */
            border-radius: 2px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 25px; /* Mayor espacio entre campos */
            position: relative;
            z-index: 1;
        }
        form label {
            font-weight: 600;
            margin-bottom: -18px; /* Ajuste para espacio */
            color: var(--text-dark);
            font-size: 1.05em; /* Ligeramente más grande */
            display: block;
        }
        form input, form select, form textarea {
            padding: 15px 20px; /* Mayor padding */
            margin: 0;
            width: 100%;
            border-radius: 12px; /* Más redondeado */
            border: 1px solid var(--border-color);
            font-size: 17px; /* Tamaño de fuente ligeramente más grande */
            box-sizing: border-box;
            transition: all 0.3s ease;
            background-color: var(--primary-light); /* Fondo suave */
            color: var(--text-dark);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Sombra interna sutil */
        }

        form input:focus, form select:focus, form textarea:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 6px hsla(200, 70%, 55%, 0.25), inset 0 1px 3px rgba(0,0,0,0.1); /* Sombra de enfoque más grande y notoria */
            outline: none;
            background-color: white; /* Fondo blanco al enfocar */
        }
        form input[readonly] {
            background-color: #f0f0f0; /* Fondo más oscuro para campos de solo lectura */
            cursor: not-allowed;
            border-style: solid; /* Borde sólido */
            border-color: hsl(210, 10%, 80%);
            color: #555;
            box-shadow: none;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas pequeñas */
            gap: 15px; /* Espacio entre botones */
            margin-top: 30px;
            justify-content: center; /* Centrar botones */
        }

        .button-group button {
            flex-grow: 1; /* Permite que los botones crezcan para ocupar espacio */
            padding: 18px 25px; /* Ajustado el padding para botones dentro del grupo */
            font-size: 17px; /* Tamaño de fuente ajustado */
            min-width: 180px; /* Ancho mínimo para cada botón */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .button-group button:hover {
            transform: translateY(-3px); /* Menos elevación para botones agrupados */
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }

        .save-pdf-button {
            background: linear-gradient(135deg, var(--accent-green) 0%, hsl(140, 75%, 35%) 100%);
            color: var(--text-light);
        }
        .save-pdf-button:hover {
            background: linear-gradient(135deg, hsl(140, 75%, 35%) 0%, var(--accent-green) 100%);
        }

        .drive-button {
            background: linear-gradient(135deg, var(--google-drive-blue) 0%, hsl(217, 70%, 40%) 100%);
            color: var(--text-light);
        }
        .drive-button:hover {
            background: linear-gradient(135deg, hsl(217, 70%, 40%) 0%, var(--google-drive-blue) 100%);
        }

        .signature-button {
            background: linear-gradient(135deg, var(--signature-purple) 0%, hsl(260, 60%, 40%) 100%);
            color: var(--text-light);
        }
        .signature-button:hover {
            background: linear-gradient(135deg, hsl(260, 60%, 40%) 0%, var(--signature-purple) 100%);
        }

        /* Flash Messages */
        .flash-messages {
            list-style: none;
            padding: 0;
            margin: 30px auto;
            text-align: center;
            width: fit-content;
            max-width: 90%;
            background-color: white;
            border-radius: 14px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            overflow: hidden; /* Asegurar bordes redondeados */
        }
        .flash-messages li {
            padding: 18px 30px;
            margin-bottom: 0;
            font-weight: 600;
            font-size: 1.05em;
            display: block;
            border: 1px solid transparent;
            position: relative;
            animation: slideInMessage 0.5s ease-out forwards;
        }
        .flash-messages li:not(:last-child) {
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        @keyframes slideInMessage {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .flash-messages .success { background-color: #e0fff2; color: #28a745; border-color: #a7f0c3; }
        .flash-messages .error { background-color: #ffe0e0; color: #dc3545; border-color: #f0a7a7; }
        .flash-messages .info { background-color: #e0f2ff; color: #007bff; border-color: #a7d9f0; }
        .flash-messages .warning { background-color: #fff9e0; color: #ffc107; border-color: #f0e6a7; }

        /* Estilos para la vista previa de imagen */
        .preview-section {
            background-color: hsl(210, 16%, 95%);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px; /* Mayor altura para la imagen */
            overflow: hidden; /* Asegurar que la imagen no se desborde */
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05); /* Sombra interna para profundidad */
        }
        .preview-section img {
            max-width: 100%;
            max-height: 100%; /* Ajustar la altura para que la imagen quepa */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
        }
        .preview-section img:hover {
            transform: scale(1.05); /* Ligeramente agrandar al pasar el ratón */
        }

        @media (max-width: 768px) {
            header {
                padding: 1.5rem 0;
            }
            header img {
                width: 100px;
            }
            header h1 {
                font-size: 28px;
            }
            .back-button, .logout-btn {
                font-size: 14px;
                padding: 10px 18px;
                top: 15px;
                left: 15px;
                right: 15px;
                gap: 8px;
            }
            .logout-btn {
                top: 70px; /* Para que no se superponga con el botón de volver en móviles */
                left: auto;
            }
            .container {
                padding: 15px;
            }
            .card {
                padding: 20px;
            }
            .card h3 {
                font-size: 22px;
                margin-bottom: 20px;
            }
            form input, form select, form textarea {
                font-size: 15px;
                padding: 12px 15px;
            }
            .button-group {
                flex-direction: column; /* Apilar botones en móvil */
            }
            .button-group button {
                width: 100%; /* Ocupar todo el ancho disponible */
                min-width: unset; /* Reiniciar min-width */
                padding: 15px 20px; /* Ajustar padding */
            }
            .preview-section {
                min-height: 120px; /* Menor altura en móvil */
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="{{ url_for('dashboard') }}" class="back-button"><i class="fa-solid fa-arrow-left"></i> Volver al Dashboard</a>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo CardioHome" />
        <h1>Rellenar Formularios</h1>
        <button class="logout-btn" onclick="cerrarSesion()"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</button>
    </header>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        {% if session.get('establecimiento') %}
            <h2 class="text-3xl font-extrabold text-primary-dark mb-8 text-center font-['Montserrat']">Nómina: {{ session['establecimiento'] }}</h2>
        {% endif %}

        {% if estudiantes %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for estudiante in estudiantes %}
                    <div class="card">
                        <h3><i class="fa-solid fa-user-injured"></i> {{ estudiante.nombre }}</h3>
                        
                        {# Sección para la vista previa de imagen #}
                        <div class="preview-section">
                            <img src="{{ url_for('static', filename='formulario_muestra.png') }}" alt="Vista Previa del Formulario" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=Imagen+No+Disponible';" />
                        </div>

                        <form action="{{ url_for('generar_pdf') }}" method="POST">
                            {# Campos ocultos para pasar el ID del estudiante y la nómina al backend #}
                            <input type="hidden" name="estudiante_id" value="{{ estudiante.id }}">
                            <input type="hidden" name="nomina_id" value="{{ session['current_nomina_id'] }}">

                            <label for="nombre_{{ estudiante.id }}">Nombre Completo:</label>
                            <input type="text" id="nombre_{{ estudiante.id }}" name="nombre" value="{{ estudiante.nombre }}" required readonly />

                            <label for="rut_{{ estudiante.id }}">RUT:</label>
                            <input type="text" id="rut_{{ estudiante.id }}" name="rut" value="{{ estudiante.rut }}" required readonly />

                            <label for="fecha_nacimiento_{{ estudiante.id }}">Fecha de Nacimiento:</label>
                            <input type="text" id="fecha_nacimiento_{{ estudiante.id }}" name="fecha_nacimiento" value="{{ estudiante.fecha_nacimiento_formato }}" required readonly />

                            <label for="edad_{{ estudiante.id }}">Edad:</label>
                            <input type="text" id="edad_{{ estudiante.id }}" name="edad" value="{{ estudiante.edad }}" required readonly />

                            <label for="nacionalidad_{{ estudiante.id }}">Nacionalidad:</label>
                            <input type="text" id="nacionalidad_{{ estudiante.id }}" name="nacionalidad" value="{{ estudiante.nacionalidad }}" required />

                            <label for="sexo_{{ estudiante.id }}">Sexo:</label>
                            <select id="sexo_{{ estudiante.id }}" name="sexo" required>
                                <option value="M" {% if estudiante.sexo == 'M' %}selected{% endif %}>Masculino</option>
                                <option value="F" {% if estudiante.sexo == 'F' %}selected{% endif %}>Femenino</option>
                            </select>

                            <label for="estado_{{ estudiante.id }}">Estado General:</label>
                            <textarea id="estado_{{ estudiante.id }}" name="estado" rows="2" placeholder="Observaciones del estado general..." required></textarea>

                            <label for="diagnostico_{{ estudiante.id }}">Diagnóstico:</label>
                            <select id="diagnostico_{{ estudiante.id }}" name="diagnostico" required>
                                <option value="">Selecciona un diagnóstico</option>
                                <option value="Trastorno espectro autista">Trastorno espectro autista</option>
                                <option value="GARC">GARC</option>
                                <option value="Trastorno por deficit de atención">Trastorno por deficit de atención</option>
                                <option value="TDAH">TDAH</option>
                                <option value="FIL">FIL</option>
                                <option value="DIL">DIL</option>
                                <option value="Sindrome de Down">Sindrome de Down</option>
                            </select>

                            <label for="fecha_reevaluacion_{{ estudiante.id }}">Fecha de Reevaluación (en años):</label>
                            <select id="fecha_reevaluacion_{{ estudiante.id }}" name="fecha_reevaluacion_anos" required>
                                <option value="">Selecciona años</option>
                                <option value="1">1 año</option>
                                <option value="2">2 años</option>
                                <option value="3">3 años</option>
                                <option value="4">4 años</option>
                                <option value="5">5 años</option>
                            </select>
                            
                            <div class="button-group">
                                <button type="submit" class="save-pdf-button">
                                    <i class="fa-solid fa-save"></i> Guardar y Generar PDF
                                </button>
                                <button type="button" class="drive-button" onclick="alert('Funcionalidad de Enviar a Drive por configurar')">
                                    <i class="fa-brands fa-google-drive"></i> Enviar al Drive
                                </button>
                                <button type="button" class="signature-button" onclick="alert('Funcionalidad de Asignar Firma por configurar')">
                                    <i class="fa-solid fa-signature"></i> Asignar Firma
                                </button>
                            </div>
                        </form>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-gray-600">No hay estudiantes en esta nómina o ha ocurrido un error al cargarlos.</p>
        {% endif %}
    </div>

    <script>
        function cerrarSesion() {
            window.location.href = "/logout";
        }
    </script>
</body>
</html>
